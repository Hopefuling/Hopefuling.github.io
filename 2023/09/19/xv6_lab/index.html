<!DOCTYPE html>
<html lang="en" class="light">
<head>
  <meta charset="utf-8">
  
  <title>
    
    xv6å®éªŒ
    
  </title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/favicon.svg" type="image/svg+xml" />
  
<script src="https://cdn.staticfile.org/prism/1.17.1/prism.min.js"></script>

  
<script src="https://cdn.staticfile.org/prism/1.17.1/plugins/autoloader/prism-autoloader.min.js"></script>

  
<link rel="stylesheet" href="/css/prism/material-light.css">

  
<link rel="stylesheet" href="/css/prism/material-dark.css">

  
<script src="https://cdn.staticfile.org/prism/1.17.1/plugins/line-numbers/prism-line-numbers.min.js"></script>

  
<link rel="stylesheet" href="https://cdn.staticfile.org/prism/1.17.1/plugins/line-numbers/prism-line-numbers.min.css">

  
<link rel="stylesheet" href="/css/style.css">

  
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&family=Noto+Sans+SC:wght@300&display=swap.css">

  
<link rel="stylesheet" href="/iconfont/iconfont.css">

<meta name="generator" content="Hexo 6.3.0"><link rel="alternate" href="/atom.xml" title="I'm Hopefuling" type="application/atom+xml">
</head>
<script>
  function setIsNight(isNight) {
    localStorage.setItem('isNight', isNight)
  }

  function getIsNight() {
    return localStorage.getItem('isNight')
  }

  function switchTheme() {
    let isNight = getIsNight()
    if (isNight === 'false') {
      document.documentElement.className = 'dark'
      document.getElementsByClassName('theme-switcher')[0].textContent = 'ğŸ˜´'
      setIsNight('true')
    } else {
      document.documentElement.className = 'light'
      document.getElementsByClassName('theme-switcher')[0].textContent = 'ğŸ˜³'
      setIsNight('false')
    }
  }

  let isNight = getIsNight()
  if (isNight == null) {
    isNight = 'false'
    setIsNight('false')
  }
  if (isNight === 'false') {
    document.documentElement.className = 'light'
  } else {
    document.documentElement.className = 'dark'
  }
</script>

<body>
  <div class="show-area">
    <header>
  <ul class="nav">
    <li class="nav-child">
      <a href="/">é¦–é¡µ</a>
    </li>
    <li class="nav-child">
      <a href="/categories">åˆ†ç±»</a>
    </li>
    <li class="nav-child">
      <a href="/tags">æ ‡ç­¾</a>
    </li>
    <li class="nav-child">
      <a href="/collection">æ”¶è—</a>
    </li>
    <li class="nav-child">
      <a href="/about">å…³äº</a>
    </li>
  </ul>
  <div class="theme-switcher" onclick="switchTheme()">ğŸ˜Š</div>
  <script>
    if (isNight === "false") {
      document.getElementsByClassName("theme-switcher")[0].textContent = "ğŸ˜Š";
    } else {
      document.getElementsByClassName("theme-switcher")[0].textContent = "ğŸ˜´";
    }
  </script>
</header>

    <main class="main-body">
  <div class="toc-container">
    <div class="toc-toggle">
      <i id="toc-b-icon" class="iconfont icon-liebiao-01" onclick="toggleShow()"></i>
    </div>
    <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Lab01"><span class="toc-number">1.</span> <span class="toc-text">Lab01</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lab01-0-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text">Lab01-0:ç¯å¢ƒé…ç½®</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lab01-1-sleep-c"><span class="toc-number">1.2.</span> <span class="toc-text">Lab01-1:sleep.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lab01-2-pingpong-c"><span class="toc-number">1.3.</span> <span class="toc-text">Lab01-2:pingpong.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lab01-3-primes-c"><span class="toc-number">1.4.</span> <span class="toc-text">Lab01-3: primes.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lab01-4-find-c"><span class="toc-number">1.5.</span> <span class="toc-text">Lab01-4:find.c</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Lab01%E5%BF%83%E5%BE%97"><span class="toc-number">1.6.</span> <span class="toc-text">Lab01å¿ƒå¾—</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lab02-system-call"><span class="toc-number">2.</span> <span class="toc-text">Lab02 system call</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Lab02-1-system-call"><span class="toc-number">2.1.</span> <span class="toc-text">Lab02-1:system call</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lab03-1-page-table"><span class="toc-number">3.</span> <span class="toc-text">Lab03-1:page table</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lab04-file-system"><span class="toc-number">4.</span> <span class="toc-text">Lab04-file system</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Lab05-net-working"><span class="toc-number">5.</span> <span class="toc-text">Lab05-net working</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B%E5%AE%9A%E4%B9%89"><span class="toc-number">5.1.</span> <span class="toc-text">ä¸€äº›å®šä¹‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#transmit"><span class="toc-number">5.2.</span> <span class="toc-text">transmit()</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#recv"><span class="toc-number">5.3.</span> <span class="toc-text">recv()</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number"></span> <span class="toc-text">å­¦ä¹ ç¬”è®°</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#1-1%E8%BF%9B%E7%A8%8B%E5%92%8C%E5%86%85%E5%AD%98"><span class="toc-number">1.</span> <span class="toc-text">1.1è¿›ç¨‹å’Œå†…å­˜</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#2-4xv6%E6%9E%B6%E6%9E%84%E7%AF%87"><span class="toc-number">2.</span> <span class="toc-text">2.4xv6æ¶æ„ç¯‡</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Other"><span class="toc-number"></span> <span class="toc-text">Other</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E5%88%B6%E4%BD%A0%E7%9A%84shell"><span class="toc-number">1.</span> <span class="toc-text">å®šåˆ¶ä½ çš„shell</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E3%80%81-%E5%AE%9A%E5%88%B6shell%E5%90%AF%E5%8A%A8%E6%AC%A2%E8%BF%8E%E7%95%8C%E9%9D%A2"><span class="toc-number">1.1.</span> <span class="toc-text">1ã€ å®šåˆ¶shellå¯åŠ¨æ¬¢è¿ç•Œé¢</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2%E3%80%81%E5%AE%9A%E5%88%B6%E5%91%BD%E4%BB%A4%E6%8F%90%E7%A4%BA%E7%AC%A6"><span class="toc-number">1.2.</span> <span class="toc-text">2ã€å®šåˆ¶å‘½ä»¤æç¤ºç¬¦</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#linux%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">2.</span> <span class="toc-text">linuxå¸¸ç”¨å‘½ä»¤</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#vim%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4"><span class="toc-number">3.</span> <span class="toc-text">vimå¸¸ç”¨å‘½ä»¤</span></a></li></ol>
  </div>
  
  <script>
    var show = false
    function toggleShow() {
      if (show) {
        document.getElementsByClassName('toc')[0].className = 'toc'
        document.getElementById('toc-b-icon').className = 'iconfont icon-liebiao-01'
      } else {
        document.getElementsByClassName('toc')[0].className = 'toc show'
        document.getElementById('toc-b-icon').className = 'iconfont icon-quxiao-01'
      }
      show = !show
    }
    document.getElementsByClassName('toc')[0].onclick = toggleShow
  </script>
  
  <div class="article-header">
    <h1 class="article-title">xv6å®éªŒ</h1>
    <div class="article-details">
      <div class="article-post-date"><span>Posted at </span> 2023-09-19</div>
      <div class="article-tags">
        
        <a href="/tags/xv6">#xv6</a>
        
      </div>
    </div>
  </div>
  <div class="article">
  
  <p><strong>author:  Hopefuling</strong></p>
<hr>
<p>å‚è€ƒæŒ‡å¯¼æ‰‹å†Œï¼š</p>
<p>xv6ä¸­æ–‡æŒ‡å¯¼æ‰‹å†Œï¼š<a target="_blank" rel="noopener" href="http://xv6.dgs.zone/">http://xv6.dgs.zone/</a></p>
<hr>
<h2 id="Lab01"><a href="#Lab01" class="headerlink" title="Lab01"></a>Lab01</h2><h3 id="Lab01-0-ç¯å¢ƒé…ç½®"><a href="#Lab01-0-ç¯å¢ƒé…ç½®" class="headerlink" title="Lab01-0:ç¯å¢ƒé…ç½®"></a>Lab01-0:ç¯å¢ƒé…ç½®</h3><p>&#x3D;&#x3D;date: 2023&#x2F;9&#x2F;12&#x3D;&#x3D;</p>
<p>å®éªŒç¯å¢ƒï¼šwindows11+ vmware+ Ubuntu 22.04</p>
<p>æŒ‰å®˜æ–¹æ–‡æ¡£é…ç½®ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">&#x2F;&#x2F;å®‰è£…ä¹‹å‰å…ˆæ¢æºï¼Œå†è½¯ä»¶æ›´æ–°
sudo apt update 

sudo apt install git build-essential gdb-multiarch qemu-system-misc gcc-riscv64-linux-gnu binutils-riscv64-linux-gnu libglib2.0-dev libpixman-1-dev gcc-riscv64-unknown-elf

&#x2F;&#x2F;æŸ¥çœ‹å®‰è£…æ˜¯å¦æˆåŠŸï¼š
riscv64-unknown-elf-gcc   --version
qemu-system-riscv64 --version


git clone git:&#x2F;&#x2F;g.csail.mit.edu&#x2F;xv6-labs-2022
cd xv6-labs-2022
git checkout util     &#x2F;&#x2F;åˆ‡æ¢åˆ°labåˆ†æ”¯util</code></pre>



<p>è¿›å…¥&#x2F;userç›®å½•ä¸‹å¯ä»¥çœ‹åˆ°xv6æŒ‡ä»¤é›†çš„æºç ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121445960.png" alt="image-20230912144518851"></p>
<p>ä»¥åŠkernelä¸‹çš„å†…æ ¸æ–‡ä»¶ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121446664.png" alt="image-20230912144611597"></p>
<h3 id="Lab01-1-sleep-c"><a href="#Lab01-1-sleep-c" class="headerlink" title="Lab01-1:sleep.c"></a>Lab01-1:sleep.c</h3><p>å®éªŒåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2020/labs/util.html">https://pdos.csail.mit.edu/6.S081/2020/labs/util.html</a> </p>
<p>ä»£ç å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab1-Xv6%20and%20Unix%20utilities.md">https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab1-Xv6%20and%20Unix%20utilities.md</a></p>
<p>åšå®¢å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://ttzytt.com/2022/07/xv6_lab1_record/">https://ttzytt.com/2022/07/xv6_lab1_record/</a>   å¿…çœ‹</p>
<p>æ£€æµ‹å‘½ä»¤å‚æ•°æ•°ç›®ï¼Œä¹‹åç›´æ¥è°ƒç”¨ç³»ç»Ÿçš„sleepå‡½æ•°å³å¯ã€‚æˆ‘é‡‡ç”¨çš„æ˜¯vimç¼–è¾‘å™¨ï¼š</p>
<p>vim &#x2F;user&#x2F; sleep.c       è¿›å…¥iç¼–è¾‘æ¨¡å¼ï¼š</p>
<p>è¾“å…¥ä»¥ä¸‹ä»£ç ï¼šï¼ˆåœ¨ä¸Šé¢çš„ç½‘ç«™æœ‰ï¼‰</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121125824.png" align="left"  >



<p>:wq ä¿å­˜é€€å‡º</p>
<p> æ‰§è¡Œsleepå‘½ä»¤ï¼š</p>
<p>å…ˆåˆ‡æ¢åˆ°xv6ç›®å½•ï¼Œvim ç¼–è¾‘Makefileï¼Œåœ¨191è¡Œå¤„æ·»åŠ $U&#x2F;_sleep\ï¼Œ:wqä¿å­˜é€€å‡ºï¼š</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121125826.png" align="left">

<p>ï¼ˆæ³¨ï¼šæ˜¾ç¤ºè¡Œå·å‘½ä»¤   :set nu ï¼‰</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121125907.png" align="left">

<p> å®Œæˆååˆ‡æ¢å›æ ¹ç›®å½•ï¼Œmake qemuæ‰§è¡Œå¯åŠ¨qemuï¼Œæ­¤æ—¶æ‰§è¡Œlså‘½ä»¤å¯ä»¥çœ‹åˆ°å‘½ä»¤é›†å·²ç»æ·»åŠ äº†sleepæŒ‡ä»¤ï¼Œè¾“å…¥sleep 5ï¼Œæ‰§è¡ŒsleepæŒ‡ä»¤ï¼Œæ‰§è¡Œç»“æœæ˜¯è¾“å…¥å…‰æ ‡çŸ­æš‚åœæ­¢ä¹‹åï¼Œç»§ç»­é—ªçƒã€‚</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121125283.png" align="left">

<p> åŠ å¤§sleepæ—¶é—´å¯ä»¥çœ‹çš„æ›´æ˜æ˜¾ã€‚æ¯”å¦‚ sleep 20</p>
<h3 id="Lab01-2-pingpong-c"><a href="#Lab01-2-pingpong-c" class="headerlink" title="Lab01-2:pingpong.c"></a>Lab01-2:pingpong.c</h3><p>é¢˜ç›®è¦æ±‚çš„é¡ºåºï¼š</p>
<ul>
<li>çˆ¶è¿›ç¨‹å‘å­è¿›ç¨‹å‘é€ 1 å­—èŠ‚</li>
<li>å­è¿›ç¨‹è¾“å‡º â€œ<pid>: received pingâ€</li>
<li>å­è¿›ç¨‹å‘çˆ¶è¿›ç¨‹å‘é€ 1 å­—èŠ‚</li>
<li>çˆ¶è¿›ç¨‹è¾“å‡º     â€œ<pid>: received pongâ€</li>
</ul>
<p><strong>å‰ç½®çŸ¥è¯†ï¼š</strong></p>
<p><strong>ç®¡é“</strong>ï¼ˆpipeï¼‰æ˜¯ä¸€ç§æœ€åŸºæœ¬çš„è¿›ç¨‹é—´é€šä¿¡æœºåˆ¶ã€‚ç®¡é“åˆ†ä¸º <strong>è¯»å‡ºç«¯</strong> å’Œ <strong>å†™å…¥ç«¯</strong> ä¸¤ä¸ªéƒ¨åˆ†ï¼Œè¿›ç¨‹å¯ä»¥å‘å†™ç«¯å†™å…¥æ•°æ®ï¼Œä¹Ÿå¯ä»¥ä»è¯»ç«¯è¯»å‡ºæ•°æ®ã€‚é€šè¿‡pipeç³»ç»Ÿè°ƒç”¨ï¼Œå†…æ ¸ä¼šä¸ºç”¨æˆ·è¿›ç¨‹åˆ›å»ºç®¡é“ï¼ŒåŒæ—¶è¿”å›ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ï¼Œç”¨ä»¥æè¿°ç®¡é“çš„è¯»å†™ç«¯ã€‚</p>
<p>åˆ›å»ºç®¡é“ ï¼š<strong>int pipe(int fd[2]);</strong> </p>
<p>è¿”å›å€¼ï¼šæˆåŠŸï¼Œè¿”å›0ï¼Œå¦åˆ™è¿”å›-1ã€‚å‚æ•°æ•°ç»„åŒ…å«pipeä½¿ç”¨çš„ä¸¤ä¸ªæ–‡ä»¶çš„æè¿°ç¬¦ã€‚</p>
<p>fd[0] å°†æ˜¯ç®¡é“è¯»å–ç«¯çš„fdï¼ˆæ–‡ä»¶æè¿°ç¬¦ï¼‰<br>fd[1] å°†æ˜¯ç®¡é“å†™å…¥ç«¯çš„fd</p>
<p> &#x2F;&#x2F; å‡½æ•°è°ƒç”¨æˆåŠŸè¿”å›r&#x2F;wä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦ã€‚å‘ç®¡é“æ–‡ä»¶è¯»å†™æ•°æ®å…¶å®æ˜¯åœ¨è¯»å†™å†…æ ¸ç¼“å†²åŒºã€‚</p>
<p>&#x2F;&#x2F; å¿…é¡»åœ¨fork()ä¸­è°ƒç”¨pipe()ï¼Œå¦åˆ™å­è¿›ç¨‹ä¸ä¼šç»§æ‰¿æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p>ç¤ºä¾‹ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">int p[2];
int ret;&#x2F;&#x2F;è¿”å›å€¼
ret &#x3D; pipe(p); &#x2F;*æ­£å¸¸åˆ›å»ºåï¼Œp[1]ä¸ºç®¡é“å†™å…¥ç«¯ï¼Œp[0]ä¸ºç®¡é“è¯»å‡ºç«¯*&#x2F; </code></pre>

<p> é€šè¿‡æ–‡ä»¶æè¿°ç¬¦ï¼Œç¨‹åºå¯ä»¥æŒ‰è¯»å†™æ–‡ä»¶çš„å½¢å¼è¯»å†™ç®¡é“ï¼Œä¾‹å¦‚ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">int write &#x3D; write(p[1], buffer, n); &#x2F;&#x2F;p[1]ä¸ºç®¡é“å†™å…¥ç«¯
int read &#x3D; read(p[0], buffer, n);	&#x2F;&#x2F;p[0]ä¸ºç®¡é“è¯»å‡ºç«¯</code></pre>

<p>è¿›ç¨‹é€šå¸¸åªæŒæœ‰æŸä¸ªç®¡é“çš„è¯»å‡ºç«¯æˆ–è€…å†™å…¥ç«¯ï¼Œå› æ­¤ä½¿ç”¨çš„æ—¶å€™éœ€è¦å°†å¦ä¸€ç«¯å…³é—­ã€‚(å•ç®¡é“)</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;* å­è¿›ç¨‹è¯»ç®¡é“ï¼Œçˆ¶è¿›ç¨‹å†™ç®¡é“ *&#x2F;
int pid &#x3D; fork();
if (pid &#x3D;&#x3D; 0) &#123;  &#x2F;* å­è¿›ç¨‹ *&#x2F; &#x2F;&#x2F;forkè¿”å›0ä¸ºå­è¿›ç¨‹
    close(p[1]); &#x2F;&#x2F; å…³é—­å†™ç«¯
    ...
    read(...);
    ...
    close(p[0]); &#x2F;&#x2F; è¯»å–å®Œæˆï¼Œå…³é—­è¯»ç«¯
&#125; 
else if (pid&gt;0) &#123;  &#x2F;* çˆ¶è¿›ç¨‹ *&#x2F; &#x2F;&#x2F;forkå¤§äº0ä¸ºçˆ¶è¿›ç¨‹
    close(p[0]); &#x2F;&#x2F; å…³é—­è¯»ç«¯
    ...
    write(...);
    ...
    close(p[1]); &#x2F;&#x2F; å†™å…¥å®Œæˆï¼Œå…³é—­å†™ç«¯
&#125;</code></pre>

<hr>
<p>é‚£ä¹ˆå®éªŒçš„å¤§è‡´æ­¥éª¤ä¸ºï¼š</p>
<ol>
<li><p>çˆ¶è¿›ç¨‹è°ƒç”¨pipeå‡½æ•°åˆ›å»ºç®¡é“ï¼Œå¾—åˆ°ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦fd[0]ã€fd[1]æŒ‡å‘ç®¡é“çš„è¯»ç«¯å’Œå†™ç«¯ã€‚</p>
</li>
<li><p>çˆ¶è¿›ç¨‹è°ƒç”¨forkåˆ›å»ºå­è¿›ç¨‹ï¼Œé‚£ä¹ˆå­è¿›ç¨‹ä¹Ÿæœ‰ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦æŒ‡å‘åŒä¸€ç®¡é“ã€‚</p>
</li>
<li><p>çˆ¶è¿›ç¨‹å…³é—­ç®¡é“è¯»ç«¯ï¼Œå­è¿›ç¨‹å…³é—­ç®¡é“å†™ç«¯ã€‚çˆ¶è¿›ç¨‹å¯ä»¥å‘ç®¡é“ä¸­å†™å…¥æ•°æ®ï¼Œå­è¿›ç¨‹å°†ç®¡é“ä¸­çš„æ•°æ®è¯»å‡ºã€‚ç”±äºç®¡é“æ˜¯åˆ©ç”¨ç¯å½¢é˜Ÿåˆ—å®ç°çš„ï¼Œæ•°æ®ä»å†™ç«¯æµå…¥ç®¡é“ï¼Œä»è¯»ç«¯æµå‡ºï¼Œè¿™æ ·å°±å®ç°äº†è¿›ç¨‹é—´é€šä¿¡ã€‚</p>
</li>
</ol>
<p>vim  user&#x2F;pingpong.c  </p>
<p>å®éªŒä»£ç ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#include &quot;kernel&#x2F;types.h&quot;
#include &quot;kernel&#x2F;stat.h&quot;
#include &quot;user&#x2F;user.h&quot;

int main(int argc, char *argv[])
&#123;
  int p1[2]; 
  int p2[2]; 
  if (pipe(p1) &lt; 0 || pipe(p2) &lt; 0) &#123;
    fprintf(2, &quot;pingpong: pipe failed\n&quot;);
    exit(1);
  &#125;
  int pid &#x3D; fork();
  if (pid &lt; 0) &#123;&#x2F;&#x2F;åˆ›å»ºå­è¿›ç¨‹å¤±è´¥
    fprintf(2, &quot;pingpong: fork child process failed\n&quot;);
    exit(1);
  &#125;
  char buf[2] &#x3D; &#123;0&#125;;
  if (pid &gt; 0) &#123; &#x2F;&#x2F; çˆ¶è¿›ç¨‹
    &#x2F;&#x2F;ç®¡é“è¯»å†™æ˜¯å•å·¥çš„ï¼Œè¯»å†™ç«¯ä¸å¯ä»¥åŒæ—¶å¼€å¯ï¼›é¿å…å­è¿›ç¨‹å†™ç«¯æœªå…³é—­ï¼Œå¹²æ‰°çˆ¶è¿›ç¨‹çš„è¯»æ“ä½œ
    close(p1[0]);	&#x2F;&#x2F;å…³é—­çˆ¶è¿›ç¨‹çš„ç®¡é“è¯»å‡ºç«¯
    close(p2[1]);	&#x2F;&#x2F;å…³é—­å­è¿›ç¨‹çš„ç®¡é“å†™å…¥ç«¯
    write(p1[1], &quot;a&quot;, 1);
    read(p2[0], buf, sizeof buf); 	&#x2F;&#x2F;çˆ¶è¿›ç¨‹è¯»æ“ä½œ
    fprintf(1, &quot;%d: received pong\n&quot;, getpid());
    close(p1[1]);
    close(p2[0]);
  &#125; else &#123; 		&#x2F;&#x2F; pid&#x3D;0 å­è¿›ç¨‹
    close(p1[1]);	&#x2F;&#x2F;å…³é—­çˆ¶è¿›ç¨‹çš„ç®¡é“å†™å…¥ç«¯
    close(p2[0]);	&#x2F;&#x2F;å…³é—­å­è¿›ç¨‹çš„ç®¡é“è¯»å‡ºç«¯
    read(p1[0], buf, sizeof buf); 	&#x2F;&#x2F;å­è¿›ç¨‹å†™æ“ä½œ
    fprintf(1, &quot;%d: received ping\n&quot;, getpid());
    write(p2[1], &quot;b&quot;, 1);
    close(p1[0]);
    close(p2[1]);
  &#125;
  wait(0);
  exit(0);
&#125;</code></pre>

<p>æ·»åŠ MakeFileä¹‹åè¿è¡Œæµ‹è¯•ï¼š</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121216493.png" alt="image-20230912121600407"  />



<p>å‚è€ƒèµ„æºï¼š</p>
<p><a target="_blank" rel="noopener" href="https://xiaoxiami.gitbook.io/linux-server/duo-jin-cheng-bian-cheng/forkhan-shu">https://xiaoxiami.gitbook.io/linux-server/duo-jin-cheng-bian-cheng/forkhan-shu</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/415609647">https://zhuanlan.zhihu.com/p/415609647</a></p>
<h3 id="Lab01-3-primes-c"><a href="#Lab01-3-primes-c" class="headerlink" title="Lab01-3: primes.c"></a>Lab01-3: primes.c</h3><p>è¯¥ç¨‹åºçš„é€»è¾‘æ˜¯æŠŠ 2-35 ä¹‹é—´çš„è´¨æ•°ç­›é€‰å‡ºæ¥ï¼Œå¹¶åœ¨ç»ˆç«¯è¿›è¡Œè¾“å‡ºã€‚çº¦å®šä»¥ä¸‹ï¼š</p>
<p>ï¼ˆ1ï¼‰ çˆ¶è¿›ç¨‹ A ç”Ÿæˆ[2-35]ä¹‹é—´çš„æ‰€æœ‰æ•°å­—ï¼ŒåŒ…æ‹¬ 2 å’Œ 35ï¼›<br>ï¼ˆ2ï¼‰ å‘ A çš„å­è¿›ç¨‹ B è¿›è¡Œè¾“å‡ºï¼ˆé€šè¿‡ç®¡é“ï¼‰ï¼›<br>ï¼ˆ3ï¼‰ B å¯¹[2-35]è¿›è¡Œç­›é€‰ï¼Œæ‰“å°å‡ºç¬¬ä¸€ä¸ªè´¨æ•° 2ï¼›<br>ï¼ˆ4ï¼‰ B æŠŠå‰©ä¸‹çš„æ•°å­—ï¼ˆé€šè¿‡ï¼‰é€šè¿‡ç®¡é“ä¼ é€’ç»™ B çš„å­è¿›ç¨‹ Cï¼›<br>ï¼ˆ5ï¼‰ C æ‰“å°å‡ºç¬¬äºŒä¸ªè´¨æ•°ï¼Œä¹Ÿå³ 3ï¼›<br>ï¼ˆ6ï¼‰ é‡å¤ï¼ˆ4ï¼‰å’Œï¼ˆ5ï¼‰çš„è¿‡ç¨‹ï¼Œç›´åˆ° 2-35 ä¹‹é—´çš„è´¨æ•°å…¨éƒ¨åœ¨ç»ˆç«¯è¾“å‡ºã€‚</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121452233.png" alt="image-20230912145203149" style="zoom:50%;" />

<p>æ€è·¯ï¼š</p>
<p>ä»ä¸»è¿›ç¨‹å¼€å§‹ï¼Œä¸æ–­æ–°å»ºå­è¿›ç¨‹ï¼Œæ¯ä¸ªå­è¿›ç¨‹æ‰§è¡Œä¸€æ¬¡ç­›é€‰ï¼Œå¹¶å°†ä½¿ç”¨çš„åŸºï¼ˆbaseï¼‰è®¤ä¸ºæ˜¯è´¨æ•°ï¼ˆè¿™æ˜¯æ­£ç¡®çš„ï¼Œè¯·æ€è€ƒä¸ºä»€ä¹ˆï¼‰ï¼Œå¹¶è¿”å›ï¼Œç›´åˆ°å…¨éƒ¨çš„æ•°éƒ½è¢«ç­›å»æˆ–è¢«è¿”å›ã€‚</p>
<p>å„ä¸ªè¿›ç¨‹ä¹‹é—´çš„é€šè®¯å°†ä¼šä½¿ç”¨åˆ°ç®¡é“ã€‚</p>
<p>è¿˜éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ul>
<li><strong>æ–‡ä»¶æè¿°ç¬¦æº¢å‡ºï¼š</strong>  xv6é™åˆ¶fdçš„èŒƒå›´ä¸º0~15ï¼Œè€Œæ¯æ¬¡pipe()éƒ½ä¼šåˆ›å»ºä¸¤ä¸ªæ–°çš„fdï¼Œå¦‚æœä¸åŠæ—¶å…³é—­ä¸éœ€è¦çš„fdï¼Œä¼šå¯¼è‡´æ–‡ä»¶æè¿°ç¬¦èµ„æºç”¨å°½ã€‚è¿™é‡Œä½¿ç”¨é‡å®šå‘åˆ°æ ‡å‡†I&#x2F;Oçš„æ–¹å¼æ¥é¿å…ç”Ÿæˆæ–°çš„fdï¼Œé¦–å…ˆclose()å…³é—­æ ‡å‡†I&#x2F;Oçš„fdï¼Œç„¶åä½¿ç”¨dup()å¤åˆ¶æ‰€éœ€çš„ç®¡é“fdï¼ˆä¼šè‡ªåŠ¨å¤åˆ¶åˆ°åºå·æœ€å°çš„fdï¼Œå³å…³é—­çš„æ ‡å‡†I&#x2F;Oï¼‰ï¼Œéšåå¯¹pipeä¸¤ä¾§fdè¿›è¡Œå…³é—­ï¼ˆæ­¤æ—¶åªä¼šç§»é™¤æè¿°ç¬¦ï¼Œä¸ä¼šå…³é—­å®é™…çš„fileå¯¹è±¡ï¼‰ã€‚</li>
<li><strong>pipelineå…³é—­ï¼š</strong>  åœ¨å®Œæˆç´ æ•°è¾“å‡ºåï¼Œéœ€è¦ä¾æ¬¡é€€å‡ºpipelineä¸Šçš„æ‰€æœ‰è¿›ç¨‹ã€‚åœ¨é€€å‡ºçˆ¶è¿›ç¨‹å‰å…³é—­å…¶æ ‡å‡†è¾“å…¥fdï¼Œæ­¤æ—¶read()å°†è¯»å–åˆ°eofï¼ˆå€¼ä¸º0ï¼‰ï¼Œæ­¤æ—¶åŒæ ·å…³é—­å­è¿›ç¨‹çš„æ ‡å‡†è¾“å…¥fdï¼Œé€€å‡ºè¿›ç¨‹ï¼Œè¿™æ ·è¿›ç¨‹é“¾ä¸Šçš„æ‰€æœ‰è¿›ç¨‹å°±å¯ä»¥é€€å‡ºã€‚</li>
<li>å‚è€ƒäºï¼š<a target="_blank" rel="noopener" href="https://zhayujie.com/mit6828-lab-util.html">https://zhayujie.com/mit6828-lab-util.html</a></li>
</ul>
<p>è¿è¡Œæµ‹è¯•ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309121629185.png" alt="image-20230912162954933"></p>
<p>æç¤º</p>
<ul>
<li><p>è¯·ç‰¢è®°è¿™ä¸ªé¢˜ç›®çš„è¦æ±‚æ˜¯<strong>é€šè¿‡å¤šçº¿ç¨‹æ¥åŠ é€Ÿç´ æ•°ç­›</strong>ï¼Œåœ¨ç¼–å†™ç¨‹åºæ—¶è¦æ£€æŸ¥è‡ªå·±çš„ç¨‹åºæ˜¯å¦æ»¡è¶³å¹¶å‘ï¼Œ<strong>ä¸€å®šä¸è¦åœ¨çˆ¶è¿›ç¨‹å†™å…¥æ‰€æœ‰æ•°å­—åå­è¿›ç¨‹æ‰å¼€å§‹å¤„ç†ï¼</strong>å³ä½¿è¿™æ ·ä¹Ÿèƒ½é€šè¿‡æµ‹è¯•ã€‚</p>
</li>
<li><p>è¯·å°å¿ƒå…³é—­è¿›ç¨‹ä¸éœ€è¦çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œå¦åˆ™ç¨‹åºå°†åœ¨ç¬¬ä¸€ä¸ªè¿›ç¨‹è¾¾åˆ° 35 ä¹‹å‰è€—å°½xv6çš„èµ„æºã€‚ï¼ˆ<strong>åŠæ—¶å…³é—­ç®¡é“éå¸¸é‡è¦ï¼ï¼ï¼</strong>ï¼‰</p>
</li>
<li><p>å½“ä¸€ä¸ªè¿›ç¨‹è¯»å–å®Œæ‰€æœ‰æ•°å­—åï¼Œåº”è¯¥ç­‰åˆ°æ‰€æœ‰ä»–çš„å­è¿›ç¨‹ç»ˆæ­¢æ‰èƒ½ç»ˆæ­¢ï¼Œä»è€Œé¿å…äº§ç”Ÿåƒµå°¸è¿›ç¨‹ã€‚ï¼ˆå–„ç”¨<code>ctrl+p</code>ï¼‰</p>
</li>
<li><p>å½“ä¸€ä¸ªç®¡é“çš„å†™ç«¯è¢«å…³é—­æ—¶ï¼Œå¯¹è¯»ç«¯è¿›è¡Œ<code>read</code>ä¼šè¿”å›0ã€‚</p>
</li>
<li><p>å†™å…¥æ‰€æœ‰æ•°å­—å<strong>å†å†™å…¥ä¸€ä¸ª0æ¥è¡¨ç¤ºå†™å…¥å®Œæ¯•</strong>ï¼Œå¦åˆ™å­è¿›ç¨‹æ— æ³•çŸ¥é“çˆ¶è¿›ç¨‹æ˜¯å¦å†™å…¥å®Œæ¯•ã€‚é‡‡å–è¿™ç§åšæ³•æ˜¯å› ä¸ºæ‰§è¡Œäº†<code>fork</code>åçˆ¶è¿›ç¨‹æ‰å…³é—­ç®¡é“å†™ç«¯ï¼Œå­è¿›ç¨‹å¹¶ä¸èƒ½æ„Ÿåº”åˆ°ç®¡é“å†™ç«¯å·²ç»å…³é—­äº†ã€‚</p>
</li>
<li><p>å‚è€ƒäºï¼š<a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/547418924">https://zhuanlan.zhihu.com/p/547418924</a></p>
</li>
</ul>
<p>å‰ç½®çŸ¥è¯†ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;*
1ã€write()å‡½æ•°ï¼š ssize_t write(int fd,const void*buf,size_t count);
å‚æ•°è¯´æ˜ï¼š
  fd:æ˜¯æ–‡ä»¶æè¿°ç¬¦ï¼ˆwriteæ‰€å¯¹åº”çš„æ˜¯å†™ï¼Œå³å°±æ˜¯1ï¼‰
  buf:é€šå¸¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œéœ€è¦å†™å…¥çš„å­—ç¬¦ä¸²
  countï¼šæ˜¯æ¯æ¬¡å†™å…¥çš„å­—èŠ‚æ•°
è¿”å›å€¼ï¼š
  æˆåŠŸï¼šè¿”å›å†™å…¥çš„å­—èŠ‚æ•°
  å¤±è´¥ï¼šè¿”å›-1å¹¶è®¾ç½®errno


2ã€read()å‡½æ•°:  ssize_t read(int fd,void*buf,size_t count)
      åŠŸèƒ½:  ç”¨äºä»æ–‡ä»¶æè¿°ç¬¦å¯¹åº”çš„æ–‡ä»¶è¯»å–æ•°æ®ï¼ˆä»æ‰“å¼€çš„è®¾å¤‡æˆ–æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼‰
å‚æ•°è¯´æ˜:
fd:      æ˜¯æ–‡ä»¶æè¿°ç¬¦
buf:     ä¸ºè¯»å‡ºæ•°æ®çš„ç¼“å†²åŒºï¼›
count:   ä¸ºæ¯æ¬¡è¯»å–çš„å­—èŠ‚æ•°ï¼ˆæ˜¯è¯·æ±‚è¯»å–çš„å­—èŠ‚æ•°ï¼Œè¯»ä¸Šæ¥çš„æ•°æ®ä¿
         å­˜åœ¨ç¼“å†²åŒºbufä¸­ï¼ŒåŒæ—¶æ–‡ä»¶çš„å½“å‰è¯»å†™ä½ç½®å‘åç§»ï¼‰
è¿”å›å€¼ï¼š
 æˆåŠŸï¼šè¿”å›è¯»å‡ºçš„å­—èŠ‚æ•°
 å¤±è´¥ï¼šè¿”å›-1ï¼Œå¹¶è®¾ç½®errnoï¼Œå¦‚æœåœ¨è°ƒç”¨readä¹‹å‰åˆ°è¾¾æ–‡ä»¶æœ«å°¾ï¼Œåˆ™è¿™æ¬¡readè¿”å›0
    
*&#x2F;  
&#x2F;&#x2F;ç¤ºä¾‹ï¼š
int main()
&#123;
   const char*msg&#x3D;&quot;hello\n&quot;;
   int len &#x3D; strlen(msg);
   write(1,msg,len);&#x2F;&#x2F;writeæ‰€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ä¸º1
   char buf[1024]&#x3D;&#123;0&#125;;
   read(0,buf,len);&#x2F;&#x2F;readæ‰€å¯¹åº”çš„æ–‡ä»¶æè¿°ç¬¦ä¸º0
   return 0;
&#125;
</code></pre>

<p>é¦–å…ˆæ‰“å¼€æç¤ºç»™å‡ºçš„é“¾æ¥ï¼Œé˜…è¯»å¹¶è§‚å¯Ÿä¸Šé¢ç»™å‡ºçš„å›¾ã€‚ç”±å›¾å¯è§ï¼Œé¦–å…ˆå°†æ•°å­—å…¨éƒ¨è¾“å…¥åˆ°æœ€å·¦è¾¹çš„ç®¡é“ï¼Œç„¶åç¬¬ä¸€ä¸ªè¿›ç¨‹æ‰“å°å‡ºè¾“å…¥ç®¡é“çš„ç¬¬ä¸€ä¸ªæ•° 2 ï¼Œå¹¶å°†ç®¡é“ä¸­æ‰€æœ‰ 2 çš„å€æ•°çš„æ•°å‰”é™¤ã€‚æ¥ç€æŠŠå‰”é™¤åçš„æ‰€æœ‰æ•°å­—è¾“å…¥åˆ°å³è¾¹çš„ç®¡é“ï¼Œç„¶åç¬¬äºŒä¸ªè¿›ç¨‹æ‰“å°å‡ºä»ç¬¬ä¸€ä¸ªè¿›ç¨‹ä¸­ä¼ å…¥ç®¡é“çš„ç¬¬ä¸€ä¸ªæ•° 3 ï¼Œå¹¶å°†ç®¡é“ä¸­æ‰€æœ‰ 3 çš„å€æ•°çš„æ•°å‰”é™¤ã€‚æ¥ç€é‡å¤ä»¥ä¸Šè¿‡ç¨‹ï¼Œæœ€ç»ˆæ‰“å°å‡ºæ¥çš„æ•°éƒ½ä¸ºç´ æ•°ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#include &quot;kernel&#x2F;types.h&quot;
#include &quot;user&#x2F;user.h&quot;

void process(int p[])
&#123;
    close(p[1]);&#x2F;&#x2F;å…³é—­å‘ç®¡é“å†™ç«¯å£
    int prime;
    if (read(p[0], &amp;prime, 4) &gt; 0) &#123; 
        fprintf(1, &quot;prime %d\n&quot;, prime);
        int p2[2];
        pipe(p2);
        if (fork() &gt; 0) &#123;&#x2F;&#x2F;parentçˆ¶è¿›ç¨‹
            close(p2[0]);&#x2F;&#x2F;å…³é—­è¯»ç«¯å£
            int i;
            while(read(p[0], &amp;i, 4) &gt; 0) &#123;
                if (i % prime !&#x3D; 0) &#123; &#x2F;&#x2F;ç­›å‡ºèƒ½è¢«primeæ•´é™¤çš„æ•°
                    write(p2[1], &amp;i, 4);&#x2F;&#x2F;å‰©ä¸‹ä¸èƒ½è¢«æ•´é™¤çš„æ•°å†™è¿›ç®¡é“
                &#125;
            &#125;
            close(p2[1]);
            wait(0);
        &#125; else &#123; &#x2F;&#x2F;å­è¿›ç¨‹é€’å½’
            close(p[0]);
            process(p2);
        &#125;
    &#125;
&#125;

int main(int argc, char* argv[])
&#123;
    int p[2];
    pipe(p);
    int pid &#x3D; fork();
    if (pid &gt; 0) &#123; &#x2F;&#x2F; parent çˆ¶è¿›ç¨‹
        close(p[0]);
        fprintf(1, &quot;prime 2\n&quot;);
        for (int i &#x3D; 3; i &lt;&#x3D; 35; ++i) &#123;
            if (i % 2 !&#x3D; 0) &#123; &#x2F;&#x2F;ä¸èƒ½è¢«2æ•´é™¤çš„æ•°å†™è¿›ç®¡é“
                write(p[1], &amp;i, 4);
            &#125;
        &#125;
        close(p[1]);  &#x2F;&#x2F;å…³é—­å†™ç«¯å£
        wait(0);
    &#125; else &#123;&#x2F;&#x2F;å­è¿›ç¨‹ é€’å½’æ“ä½œ
        process(p);
    &#125;
    exit(0);
&#125;</code></pre>







<h3 id="Lab01-4-find-c"><a href="#Lab01-4-find-c" class="headerlink" title="Lab01-4:find.c"></a>Lab01-4:find.c</h3><p>ç¼–å†™ä¸€ä¸ªç®€å•ç‰ˆæœ¬çš„ UNIX æŸ¥æ‰¾ç¨‹åºï¼šåœ¨ç›®å½•æ ‘ä¸­æŸ¥æ‰¾åç§°ä¸å­—ç¬¦ä¸²åŒ¹é…çš„æ‰€æœ‰æ–‡ä»¶ã€‚</p>
<p><strong>æç¤ºï¼š</strong></p>
<ul>
<li>æŸ¥çœ‹ user&#x2F;ls.c ä»¥äº†è§£å¦‚ä½•è¯»å–ç›®å½•ã€‚</li>
<li>ä½¿ç”¨é€’å½’å…è®¸æŸ¥æ‰¾ä¸‹é™åˆ°å­ç›®å½•ã€‚</li>
<li>ä¸è¦é€’å½’åˆ°â€œã€‚â€ å’Œ â€..â€ã€‚</li>
</ul>
<p>ä»ls.cç¨åŠ ä¿®æ”¹å³å¯ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;&#x2F;ls.c
#include &quot;kernel&#x2F;types.h&quot;
#include &quot;kernel&#x2F;stat.h&quot;
#include &quot;user&#x2F;user.h&quot;
#include &quot;kernel&#x2F;fs.h&quot;

&#x2F;&#x2F; linuxç›®å½•çš„å½¢å¼æ˜¯ &#x2F;bin  å‰é¢æœ‰ä¸ª&#x2F;

char *
fmtname(char *path)
&#123;
    static char buf[DIRSIZ + 1];
    char *p;

    &#x2F;&#x2F; Find first character after last slash.
    for (p &#x3D; path + strlen(path); p &gt;&#x3D; path &amp;&amp; *p !&#x3D; &#39;&#x2F;&#39;; p--)
        ;
    p++;

    &#x2F;&#x2F; Return blank-padded name.
    if (strlen(p) &gt;&#x3D; DIRSIZ)
        return p;
    memmove(buf, p, strlen(p));
    memset(buf + strlen(p), &#39; &#39;, DIRSIZ - strlen(p));
    return buf;
&#125;

void ls(char *path)
&#123;
    char buf[512], *p;
    int fd;
    struct dirent de; &#x2F;&#x2F;è¿™ä¸ªæŒ‡çš„æ˜¯ç›®å½•é¡¹è¿™ä¸€ç»“æ„ä½“ï¼ˆåœ¨kernel&#x2F;fs.hä¸­å®šä¹‰ï¼‰ï¼Œå…¶å®ç›®å½•ä¹Ÿæ˜¯ä¸€ç§æ–‡ä»¶ï¼Œé‡Œé¢å°±æ˜¯å­˜æ”¾äº†ä¸€ç³»åˆ—çš„ç›®å½•é¡¹
    struct stat st;   &#x2F;&#x2F;è¿™ä¸ªæŒ‡çš„æ˜¯æ–‡ä»¶çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆåœ¨kernel&#x2F;stat.hä¸­å®šä¹‰ï¼‰ï¼ŒåŒ…å«æ–‡ä»¶ç±»å‹ï¼ˆç›®å½•æˆ–æ–‡ä»¶ï¼‰&#x2F;inode&#x2F;æ–‡ä»¶å¼•ç”¨nlink&#x2F;æ–‡ä»¶å¤§å°&#x2F;å­˜æ”¾fsçš„disk dev

    if ((fd &#x3D; open(path, 0)) &lt; 0)
    &#123; &#x2F;&#x2F;æ‰“å¼€æ–‡ä»¶ï¼Œç¬¬äºŒä¸ªå‚æ•°æŒ‡ç¤ºçš„æ˜¯æ‰“å¼€æ–¹å¼ï¼Œ0ä»£è¡¨çš„æ˜¯O_RDONLYåªè¯»çš„å½¢å¼ã€‚è¿”å›å€¼æ˜¯file descriptor &gt;&#x3D;0ï¼Œ&lt;0è¯´æ˜openå¤±è´¥
        fprintf(2, &quot;ls: cannot open %s\n&quot;, path);
        return;
    &#125;

    if (fstat(fd, &amp;st) &lt; 0)
    &#123; &#x2F;&#x2F; fstatçš„å«ä¹‰åŒopenç±»ä¼¼
        fprintf(2, &quot;ls: cannot stat %s\n&quot;, path);
        close(fd);
        return;
    &#125;

    switch (st.type)
    &#123;&#x2F;&#x2F; switch ä¸­ä¸»è¦æ˜¯ä¸¤ä¸ªé€»è¾‘ï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶å¦‚ä½•å¤„ç†ï¼Œä¸€ä¸ªæ˜¯ç›®å½•æ€ä¹ˆå¤„ç†
    case T_FILE:&#x2F;&#x2F;å¦‚æœæ˜¯æ–‡ä»¶ï¼Œç›´æ¥æ‰“å°ä¿¡æ¯
        printf(&quot;%s %d %d %l\n&quot;, fmtname(path), st.type, st.ino, st.size);
            &#x2F;&#x2F; st.typeä¸­ä¸‰ä¸ªå€¼åˆ†åˆ«æ˜¯(&#123;1:ç›®å½•,2:æ–‡ä»¶,3:console&#125;) fmtnameè¿”å›å€¼å°±æ˜¯æ–‡ä»¶åç§°
        break;

    case T_DIR:
        if (strlen(path) + 1 + DIRSIZ + 1 &gt; sizeof buf)
        &#123; &#x2F;&#x2F;æ£€æŸ¥ç¼“å­˜æœ‰æ²¡æœ‰æº¢å‡º
            printf(&quot;ls: path too long\n&quot;);
            break;
        &#125;
        strcpy(buf, path);
        p &#x3D; buf + strlen(buf);
        *p++ &#x3D; &#39;&#x2F;&#39;; &#x2F;&#x2F;æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œä»¥è·¯å¾„åè®¿é—®è¿™ä¸ªç›®å½•é‡Œé¢çš„å†…å®¹
        while (read(fd, &amp;de, sizeof(de)) &#x3D;&#x3D; sizeof(de))
        &#123;&#x2F;&#x2F;è®¿é—®ç›®å½•å†…å®¹ã€‚æ¯æ¬¡readåªæ˜¯readä¸€ä¸ªdeçš„å¤§å°ï¼ˆä¹Ÿå°±æ˜¯ä¸€ä¸ªç›®å½•é¡¹ï¼‰ï¼Œåªæœ‰readåˆ°æœ€åä¸€ä¸ªç›®å½•é¡¹çš„ä¸‹ä¸€æ¬¡readæ‰ä¼šè¿”å›0ï¼Œä¹Ÿå°±ä¸æ»¡è¶³whileå¾ªç¯æ¡ä»¶é€€å‡ºå¾ªç¯ï¼Œ
            if (de.inum &#x3D;&#x3D; 0) &#x2F;&#x2F;æ­¤æ–‡ä»¶å¤¹æ— æ–‡ä»¶ï¼Œcontinueæ“ä½œåè¿›è¡Œä¸‹ä¸€æ¬¡read
                continue;
            memmove(p, de.name, DIRSIZ); 
            &#x2F;&#x2F; memmoveä¸ºå†…å­˜ä¹‹é—´çš„è¿ç§»ï¼Œåœ¨ls.cé‡Œé¢çš„æ„æ€å°±æ˜¯å°†de.nameçš„å†…å®¹ç§»åŠ¨åˆ°pæŒ‡å‘çš„æŒ‡é’ˆä¸­
            p[DIRSIZ] &#x3D; 0;
            if (stat(buf, &amp;st) &lt; 0)
            &#123;
                printf(&quot;ls: cannot stat %s\n&quot;, buf);
                continue;
            &#125;
            printf(&quot;%s %d %d %d\n&quot;, fmtname(buf), st.type, st.ino, st.size);
        &#125;
        break;
    &#125;
    close(fd);
&#125;

int main(int argc, char *argv[])
&#123;
    int i;
    if (argc &lt; 2)
    &#123;
        ls(&quot;.&quot;); &#x2F;&#x2F;é»˜è®¤å±•ç¤ºå½“å‰å·¥ä½œç›®å½•çš„æ‰€æœ‰æ–‡ä»¶
        exit(0);
    &#125;
    for (i &#x3D; 1; i &lt; argc; i++)
        ls(argv[i]); &#x2F;&#x2F; ls å’Œæˆ‘ä»¬ç†ŸçŸ¥çš„linuxçš„lsæ˜¯ä¸å¤ªç›¸åŒçš„ï¼Œxv6çš„lsæ˜¯å¯ä»¥æ¥å—å¤šä¸ªç›®å½•ä½œä¸ºå‚æ•°çš„
    exit(0);
&#125;




&#x2F;&#x2F; kernel&#x2F;fs.h
struct dirent
&#123;
    ushort inum;
    char name[DIRSIZ];
&#125;;

&#x2F;&#x2F; kernel&#x2F;stat.h
#define T_DIR 1    &#x2F;&#x2F; Directory
#define T_FILE 2   &#x2F;&#x2F; File
#define T_DEVICE 3 &#x2F;&#x2F; Device

struct stat
&#123;
    int dev;     &#x2F;&#x2F; File system&#39;s disk device
    uint ino;    &#x2F;&#x2F; Inode number
    short type;  &#x2F;&#x2F; Type of file
    short nlink; &#x2F;&#x2F; Number of links to file
    uint64 size; &#x2F;&#x2F; Size of file in bytes
&#125;;</code></pre>





<pre class="line-numbers language-c" data-language="c"><code class="language-c">#include &quot;kernel&#x2F;types.h&quot;
#include &quot;kernel&#x2F;stat.h&quot;
#include &quot;user&#x2F;user.h&quot;
#include &quot;kernel&#x2F;fs.h&quot;
 
char*
fmtname(char *path) &#x2F;&#x2F;æ ¼å¼åŒ–åå­—ï¼ŒæŠŠåå­—å˜æˆå‰é¢æ²¡æœ‰å·¦æ–œæ &#x2F;ï¼Œä»…ä»…ä¿å­˜æ–‡ä»¶å
&#123;
  static char buf[DIRSIZ+1];
  char *p;
 
  &#x2F;&#x2F; Find first character after last slash.
  for(p&#x3D;path+strlen(path); p &gt;&#x3D; path &amp;&amp; *p !&#x3D; &#39;&#x2F;&#39;; p--)
    ;
  p++;
 
  &#x2F;&#x2F; Return blank-padded name.
  memmove(buf, p, strlen(p) + 1);
  return buf;
&#125;
 
void
find(char *path, char* findName)
&#123;
  char buf[512], *p;
  int fd;
  struct dirent de;
  struct stat st;
 
  if((fd &#x3D; open(path, 0)) &lt; 0)&#123;
    fprintf(2, &quot;find: cannot open %s\n&quot;, path);
    return;
  &#125;
 
  if(fstat(fd, &amp;st) &lt; 0)&#123;
    fprintf(2, &quot;find: cannot stat %s\n&quot;, path);
    close(fd);
    return;
  &#125;
 
  switch(st.type)&#123;
  case T_FILE:&#x2F;&#x2F; å¦‚æœæ˜¯æ–‡ä»¶ç±»å‹ï¼Œé‚£ä¹ˆæ¯”è¾ƒï¼Œæ–‡ä»¶åæ˜¯å¦åŒ¹é…ï¼ŒåŒ¹é…åˆ™è¾“å‡º
    if(strcmp(fmtname(path), findName) &#x3D;&#x3D; 0)
      printf(&quot;%s\n&quot;, path);
    break;
  case T_DIR:&#x2F;&#x2F;å¦‚æœæ˜¯ç›®å½•åˆ™é€’å½’å»æŸ¥æ‰¾
    if(strlen(path) + 1 + DIRSIZ + 1 &gt; sizeof buf)&#123;&#x2F;&#x2F;æ£€æŸ¥ç¼“å­˜æœ‰æ²¡æœ‰æº¢å‡º
      printf(&quot;find: path too long\n&quot;);
      break;
    &#125;
    strcpy(buf, path);
    p &#x3D; buf+strlen(buf);
    &#x2F;&#x2F;æ‹¼æ¥å­—ç¬¦ä¸²ï¼Œä»¥è·¯å¾„åè®¿é—®è¿™ä¸ªç›®å½•é‡Œé¢çš„å†…å®¹
    *p++ &#x3D; &#39;&#x2F;&#39;;&#x2F;&#x2F;bufæ˜¯ä¸€ä¸ªç»å¯¹è·¯å¾„ï¼Œpæ˜¯ä¸€ä¸ªæ–‡ä»¶åï¼Œå¹¶é€šè¿‡åŠ &quot;&#x2F;&quot;å‰ç¼€æ‹¼æ¥åœ¨bufçš„åé¢
    while(read(fd, &amp;de, sizeof(de)) &#x3D;&#x3D; sizeof(de))&#123;
      if(de.inum &#x3D;&#x3D; 0) &#123;&#x2F;&#x2F;æ­¤æ–‡ä»¶å¤¹æ— æ–‡ä»¶ï¼Œcontinueæ“ä½œåè¿›è¡Œä¸‹ä¸€æ¬¡read 
        continue;
        &#125;
      memmove(p, de.name, DIRSIZ);&#x2F;&#x2F;memmove, æŠŠde.nameä¿¡æ¯å¤åˆ¶p,å…¶ä¸­de.nameæ˜¯char name[255],ä»£è¡¨æ–‡ä»¶å
      p[strlen(de.name)] &#x3D; 0; &#x2F;&#x2F; è®¾ç½®æ–‡ä»¶åç»“æŸç¬¦
        if(strcmp(de.name, &quot;.&quot;) &#x3D;&#x3D; 0 || strcmp(de.name, &quot;..&quot;) &#x3D;&#x3D; 0) &#123;
                continue;
        &#125;
        find(buf, findName);
    &#125;
    break;
  &#125;
  close(fd);
&#125;
 
int
main(int argc, char *argv[])
&#123;
 
  if(argc &lt; 3)&#123;
        printf(&quot;error argc num&quot;);
    exit(0);
  &#125;
  find(argv[1], argv[2]);
  exit(0);
&#125;</code></pre>





<h3 id="Lab01å¿ƒå¾—"><a href="#Lab01å¿ƒå¾—" class="headerlink" title="Lab01å¿ƒå¾—"></a>Lab01å¿ƒå¾—</h3><p>ä¸Šå­¦æœŸå­¦ä¹ æ“ä½œç³»ç»Ÿçš„æ—¶å€™è·Ÿç€å­¦äº†ä¸€å°æ®µçš„xv6ï¼Œä»åˆšå¼€å§‹çš„é…ç½®ç¯å¢ƒé…äº†å¤§å‡ å¤©ï¼ˆæ—©çŸ¥é“è¿˜å¾—æ˜¯ç”¨dockerï¼‰ï¼Œä¹‹åæ¢äº†é•œåƒï¼Œè¿™å­¦æœŸå±…ç„¶è¯¾ç¨‹é¡¹ç›®è¿˜æ˜¯è¿™ä¸ªxv6ï¼ˆæ‚²ï¼‰ï¼Œã€‚ã€‚ä½†æ˜¯åœ¨è¿™ä¹ˆæŠ˜è…¾é…ç½®ç¯å¢ƒçš„é”»ç‚¼ä¸‹ï¼Œè¿™æ¬¡é‡æ–°é…ç½®ç¯å¢ƒéå¸¸å¿«ï¼ˆåŒæ—¶ä¹Ÿå¯¹æˆ‘å­¦ä¹ å…¶ä»–linuxç¯å¢ƒä¸‹çš„è½¯ä»¶ç­‰éƒ½å¾ˆæœ‰å¸®åŠ©ï¼Œé‡åˆ°é—®é¢˜ä¹Ÿä¼šç§¯æçš„å»æ’æŸ¥ï¼‰ã€‚</p>
<p>è¿™å‡ ä¸ªå®éªŒä¸Šå­¦æœŸéƒ½åšè¿‡äº†ï¼Œè¿™æ¬¡é‡æ–°åšï¼Œé¡ºä¾¿æ•´ç†äº†ç¬”è®°ï¼Œä¹ŸæŠŠæ¯ä¸€ä¸ªlabéƒ½çœ‹æ‡‚äº†ï¼Œä¹‹å‰é¥¶æœ‰å…´è¶£çœ‹äº†xv6ä¸‹çš„userè¿˜è¦kernelçš„æºç ï¼ˆè‚¯å®šçœ‹çš„ä¸å¤šè€Œä¸”çœ‹ä¸å¤ªæ‡‚ï¼‰ï¼Œåœ¨è¿™ä¹‹å‰ä¼šä»¥ä¸ºshellæ˜¯ä¸ªå¾ˆæ·±çš„ä¸œè¥¿ï¼Œå®é™…ä¸Šä¹Ÿå°±æ˜¯ä¸€ä¸ªä¸ªå‘½ä»¤æ–‡ä»¶ä»¥åŠå†…æ ¸æ–‡ä»¶ç»„æˆçš„ï¼Œå¯ä»¥éšæ„è‡ªå®šä¹‰æ“ä½œå‘½ä»¤ï¼Œä¹Ÿå¯ä»¥è‡ªå®šä¹‰shellç»ˆç«¯é¡µé¢ï¼š</p>
<p>è›®æœ‰æ„æ€çš„ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309131350576.png" alt="image-20230913135024489"></p>
<h2 id="Lab02-system-call"><a href="#Lab02-system-call" class="headerlink" title="Lab02 system call"></a>Lab02 system call</h2><h3 id="Lab02-1-system-call"><a href="#Lab02-1-system-call" class="headerlink" title="Lab02-1:system call"></a>Lab02-1:system call</h3><p>å®éªŒåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2020/labs/syscall.html">https://pdos.csail.mit.edu/6.S081/2020/labs/syscall.html</a></p>
<p>å‰ç½®çŸ¥è¯†ï¼šgdbè°ƒè¯•    <a target="_blank" rel="noopener" href="https://www.chens.life/posts/mit-xv6-lab2/">https://www.chens.life/posts/mit-xv6-lab2/</a>     </p>
<p><strong>é…åˆåˆ«äººçš„åšå®¢ç¬”è®°ä¸€èµ·é£Ÿç”¨ï¼š</strong><a target="_blank" rel="noopener" href="https://ttzytt.com/2022/07/xv6_lab2_record/index.html">https://ttzytt.com/2022/07/xv6_lab2_record/index.html</a>     ï¼ˆå¿…çœ‹ï¼ï¼ï¼‰</p>
<p><a target="_blank" rel="noopener" href="https://miaochenlu.github.io/2020/12/16/xv6-lab2/">https://miaochenlu.github.io/2020/12/16/xv6-lab2/</a></p>
<hr>
<p>Labè¦æ±‚ï¼šå®ç°ä¸€ä¸ªè¿½è¸ªç‰¹å®šè¿›ç¨‹ç³»ç»Ÿè°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå«åš traceã€‚æ¯”å¦‚æœ‰ä¸ªè¿›ç¨‹è°ƒç”¨äº†è¿™ä¸ª traceï¼Œé‚£ä¹ˆ trace å°±ä¼šä»¥ç‰¹å®šæ ¼å¼è¾“å‡ºè¿™ä¸ªè¿›ç¨‹è°ƒç”¨è¿‡çš„ç³»ç»Ÿè°ƒç”¨ã€‚å…¶ä¸­ï¼Œæœ‰ä¸€ä¸ª mask ä½œä¸ºå‚æ•°ï¼ŒæŒ‡å®šæœ‰å“ªäº›è°ƒç”¨éœ€è¦è¢«è¿½è¸ªã€‚</p>
<p>å®éªŒä¸»é¡µç»™å‡ºäº†traceæ‰§è¡Œçš„å››ä¸ªä¾‹å­ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">$ trace 32 grep hello README
3: syscall read -&gt; 1023
3: syscall read -&gt; 966
3: syscall read -&gt; 70
3: syscall read -&gt; 0
$
#æ‰“å°å†…å®¹ä»…æ‰“å°äº†grepè·Ÿè¸ªreadç³»ç»Ÿè°ƒç”¨ã€‚32&#x3D;2^5ï¼Œâ€œThe 32 is 1&lt;&lt;SYS_read.â€ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œè¿™è¡Œå‘½ä»¤ï¼Œåªè·Ÿè¸ªç³»ç»Ÿè°ƒç”¨å·ä¸º5çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œçœ‹åˆ°åé¢çš„syacall.hå°±ä¼šå‘ç°SYS_read&#x3D;5,ä¹Ÿå°±æ˜¯readçš„è¿™ä¸ªè°ƒç”¨å·å°±æ˜¯5ï¼Œæ‰€ä»¥è¾“å‡ºåªæ‰“å°å‡ºäº†readçš„è°ƒç”¨è¿‡ç¨‹ã€‚
--------------------------------------------
$ trace 2147483647 grep hello README
4: syscall trace -&gt; 0
4: syscall exec -&gt; 3
4: syscall open -&gt; 3
4: syscall read -&gt; 1023
4: syscall read -&gt; 966
4: syscall read -&gt; 70
4: syscall read -&gt; 0
4: syscall close -&gt; 0
$
#2147483647å³01111111111111111111111111111111ï¼Œå…¶ä½31ä¸ºå…¨éƒ¨ä¸º 1 ï¼Œå°±è¯æ˜ 30å·ï¼ˆåŒ…æ‹¬30å·ï¼‰ä»¥ä¸‹çš„ç³»ç»Ÿè°ƒç”¨éƒ½éœ€è¦è·Ÿè¸ªï¼‰
#2147483647è¿™æ˜¯intæ•´å‹çš„æœ€å¤§å€¼ï¼Œè¶³ä»¥åŒ…æ‹¬æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œå› æ­¤è¿™æ˜¯æ‰“å°å‡ºæ‰§è¡Œå‘½ä»¤æ•´ä¸ªè¿‡ç¨‹çš„æ‰€æœ‰çš„ç³»ç»Ÿè°ƒç”¨ã€‚
--------------------------------------------
$ grep hello README
$
#æ²¡è°ƒç”¨traceï¼Œä¸æ‰“å°è°ƒç”¨è¿‡ç¨‹çš„ä»»ä½•å†…å®¹ï¼Œåªæ‰§è¡Œå‘½ä»¤ã€‚
--------------------------------------------
$ trace 2 usertests forkforkfork
usertests starting       					  #è¡¨ç¤ºè¡¨ç¤º usertests è¿›ç¨‹å·²å¼€å§‹æ‰§è¡Œ
test forkforkfork: 407: syscall fork -&gt; 408	  #è¡¨ç¤ºè¿›ç¨‹ 407 æ‰§è¡Œäº†ç³»ç»Ÿè°ƒç”¨ forkï¼Œåˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹ 408
408: syscall fork -&gt; 409					  #è¡¨ç¤ºè¿›ç¨‹ 408 æ‰§è¡Œäº†ç³»ç»Ÿè°ƒç”¨ forkï¼Œåˆ›å»ºäº†ä¸€ä¸ªå­è¿›ç¨‹ 409
409: syscall fork -&gt; 410					  #....ç±»ä¼¼ä¸Šé¢ã€‚ã€‚ã€‚
410: syscall fork -&gt; 411
409: syscall fork -&gt; 412
410: syscall fork -&gt; 413
409: syscall fork -&gt; 414
411: syscall fork -&gt; 415
...
#2&#x3D;2^1,ä¹Ÿå°±æ˜¯ä¼ å…¥çš„ç³»ç»Ÿè°ƒç”¨å·ä¸º1ï¼Œæ‰¾åˆ°syscall.hä¸­å¯¹åº”çš„SYS_fork&#x3D;1,å› æ­¤è¿™è¡Œå‘½ä»¤è¡¨ç¤ºä½¿ç”¨ trace å‘½ä»¤å¯¹ usertests forkforkfork ç¨‹åºè¿›è¡Œè¯¦ç»†çš„ç³»ç»Ÿè°ƒç”¨è¿½è¸ªã€‚forkforkforkæ˜¯ç³»ç»Ÿæ²¡æœ‰çš„ï¼Œè‡ªå®šä¹‰çš„æµ‹è¯•å‘½ä»¤ï¼Œè¿™ä¸ªå‘½ä»¤ä¸æ–­çš„ç”Ÿæˆå­è¿›ç¨‹ï¼Œæ¯ä¸ªå­è¿›ç¨‹ä¸­éƒ½ä¼šå†æ¬¡è°ƒç”¨ forkï¼Œä»è€Œåˆ›å»ºæ›´å¤šçš„å­è¿›ç¨‹ï¼Œå½¢æˆè¿›ç¨‹æ ‘çš„ç»“æ„ã€‚</code></pre>

<p>é™„ï¼šxv6çš„ç³»ç»Ÿè°ƒç”¨ï¼ˆ æŸ¥çœ‹ kernel&#x2F;syscall.hï¼‰</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309151905003.png" alt="image-20230915190519923" style="zoom: 60%;" align="left" />





<p>çœ‹å®Œå‡ ç¯‡åšå®¢ï¼Œç•¥æ‡‚äº†ç³»ç»Ÿè°ƒç”¨çš„å¤§è‡´è¿‡ç¨‹ã€‚ä¸‹é¢ç€æ‰‹åšå®éªŒï¼š</p>
<p>å®éªŒæ­¥éª¤</p>
<p>1ã€å…ˆåˆ‡æ¢åˆ°syscalllåˆ†æ”¯ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git fetch
git checkout syscall</code></pre>

<p>å†æ¬¡è¿›å…¥&#x2F;user&#x2F;å³å¯çœ‹åˆ°æ–°å¢äº†trace.cã€‚vimæŸ¥çœ‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152107619.png" alt="image-20230915210713497"></p>
<p>2ã€ç¡®ä¿æ­£ç¡®ç¼–è¯‘trace.c</p>
<p>ç›´æ¥æ·»åŠ $U_&#x2F;trace\åˆ°Makefileï¼Œå†æ‰§è¡Œç¼–è¯‘åå‘ç°ç¼–è¯‘å¤±è´¥ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152117055.png" alt="image-20230915211726993"></p>
<p>è¯¾ç¨‹ä¸»é¡µä¹Ÿè¯¦ç»†è¯´æ˜äº†æ“ä½œæ­¥éª¤ï¼š</p>
<p>Some hints:  </p>
<ul>
<li><p>Add <code>$U/_trace</code> to UPROGS in Makefile            æ·»åŠ $U&#x2F;_trace</p>
</li>
<li><p>Run make qemu and you will see that the compiler cannot compile <code>user/trace.c</code>, because the user-space stubs for the system call donâ€™t exist yet:   ä¸‹é¢æ˜¯éœ€è¦æ›´æ”¹çš„æ–‡ä»¶ï¼š</p>
<p><strong>add a prototype for the system call to <code>user/user.h</code>, a stub to <code>user/usys.pl</code>, and a syscall number to <code>kernel/syscall.h</code>.  The Makefile invokes the perl script <code>user/usys.pl</code>, which produces <code>user/usys.S</code>,  the actual system call stubs, which use the RISC-V <code>ecall</code> instruction to transition to the kernel. Once you fix the compilation issues,  run trace 32 grep hello README; it will fail because you havenâ€™t implemented the system call in the kernel yet.</strong>        </p>
</li>
<li><p>Add a <code>sys_trace()</code> function in <code>kernel/sysproc.c</code> that implements the new system call by remembering its argument in a new variable in the <code>proc</code> structure (see <code>kernel/proc.h</code>). The functions to retrieve system call arguments from user space are in <code>kernel/syscall.c</code>, and you can see examples        of their use in <code>kernel/sysproc.c</code>.   </p>
</li>
<li><p>Modify <code>fork()</code> (see <code>kernel/proc.c</code>) to copy    the trace mask from the parent to the child process. </p>
</li>
<li><p>Modify the <code>syscall()</code> function in <code>kernel/syscall.c</code> to print the trace output. You will need to add an array of syscall names to index into.</p>
</li>
</ul>
<hr>
<p>å› æ­¤è¿™æ­¥è¦åšçš„å°±æ˜¯å°†traceè¿™ä¸ªå‘½ä»¤åŠ è½½åˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œæ·»åŠ ä¸€äº›å†…å®¹åˆ°ä¸€äº›æ–‡ä»¶é‡Œé¢å»ã€‚</p>
<p>é¦–å…ˆæ˜¯åœ¨ç”¨æˆ·æ€çš„ <code>user/user.h</code> ä¸­ç”³æ˜ä¸€ä¸‹ï¼Œä½¿å¾—ç”¨æˆ·èƒ½é€šè¿‡è°ƒç”¨è¿™ä¸ªæ¥å£å»è°ƒç”¨æ±‡ç¼–ä»£ç ï¼Œä»è€Œè¿›å…¥å†…æ ¸ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309191923947.png" alt="image-20230915212348816"></p>
<p>æ–°å¢åœ¨äº†ç¬¬25è¡Œï¼Œæ¥å—ä¸€ä¸ªå‚æ•°ä¸ºmaskï¼Œå³ç³»ç»Ÿè°ƒç”¨å·ã€‚</p>
<p>å¦‚å‰æ–‡æ‰€è®²ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨æ±‡ç¼–å»å®ç°è¿™ä¸ªè·³è½¬å‡½æ•°ã€‚ä¸è¿‡ï¼Œè¿™ä¸ªæ±‡ç¼–æ˜¯ perl çš„è„šæœ¬è‡ªåŠ¨ç”Ÿæˆçš„ï¼Œæ‰€ä»¥éœ€è¦å»æ›´æ”¹è¿™ä¸ªè„šæœ¬ï¼ˆ<code>user/usys.pl</code>ï¼‰ã€‚</p>
<p>vimè¿›å…¥usys.plï¼Œå¹¶åœ¨æœ€åæ–°å¢ï¼šentry(â€œtraceâ€);   </p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309191923445.png" alt="image-20230915212714998"></p>
<p>ï¼ˆæ³¨ï¼šä¹‹åæˆ‘ä»¬ make qemu çš„æ—¶å€™ï¼Œåœ¨è„šæœ¬ä¸­æ–°åŠ çš„è¿™ä¸ª entry å°±ä¼šåœ¨ user&#x2F;usys.S ä¸­è¾“å‡ºï¼šï¼‰</p>
<pre class="line-numbers language-nasm" data-language="nasm"><code class="language-nasm">.global trace
trace:
 li a7, SYS_trace
 ecall
 ret</code></pre>

<p>æŠŠSYS_traceè¿™ä¸ªç³»ç»Ÿè°ƒç”¨å·æ”¾å…¥å¯„å­˜å™¨a7ï¼Œç„¶åecallè¿›å…¥å†…æ ¸æ¨¡å¼ã€‚</p>
<p>åˆ°æ­¤ä¸ºæ­¢å·²ç»å®Œæˆäº†åœ¨ç”¨æˆ·æ€çš„æ³¨å†Œã€‚æ¥ä¸‹æ¥éœ€è¦åœ¨å†…æ ¸ä¸­æ³¨å†Œã€‚ç°åœ¨æˆ‘ä»¬éœ€è¦åœ¨ <code>kernel/syscall.h</code> ç»™è¿™ä¸ªæ–°çš„è°ƒç”¨æ³¨å†Œä¸€ä¸ªè°ƒç”¨å·ï¼Œè¿™æ ·æ‰èƒ½é€šè¿‡è°ƒç”¨å·æ‰¾åˆ°å‡½æ•°ã€‚</p>
<p>vim syscall.h </p>
<p>åœ¨æœ€åæ·»åŠ ï¼š #define SYS_trace  22</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152129423.png" alt="image-20230915212920365"></p>
<p>ç„¶åï¼Œå°±åƒä¹‹å‰ä»‹ç»çš„ï¼Œå†…æ ¸ä¸­çš„ä¸­è½¬å‡½æ•° <code>syscall()</code> éœ€è¦é€šè¿‡ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ•°ç»„æ¥æŸ¥æ‰¾éœ€è¦è°ƒç”¨çš„å‡½æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦å»åœ¨è¿™ä¸ªæ•°ç»„ä¸­æ–°åŠ ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶ä¸”ç”³æ˜ä¸€ä¸‹è¿™ä¸ª trace å‡½æ•°ã€‚</p>
<p>vimè¿›å…¥&#x2F;kernel&#x2F;syscall.cï¼š</p>
<p>æ›´æ”¹åœ¨104è¡Œä»¥åŠ130è¡Œï¼šextern uint64 sys_trace(void);              [SYS_trace] sys_trace, </p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152132936.png" alt="image-20230915213251819"></p>
<p>è¿™é‡Œ <code>[SYS_trace] sys_trace</code> æ˜¯ C è¯­è¨€æ•°ç»„çš„ä¸€ä¸ªè¯­æ³•ï¼Œè¡¨ç¤ºä»¥æ–¹æ‹¬å·å†…çš„å€¼ä½œä¸ºå…ƒç´ ä¸‹æ ‡ã€‚æ¯”å¦‚ <code>int arr[] = &#123;[3] 2333, [6] 6666&#125;</code> ä»£è¡¨ arr çš„ä¸‹æ ‡ 3 çš„å…ƒç´ ä¸º 2333ï¼Œä¸‹æ ‡ 6 çš„å…ƒç´ ä¸º 6666ï¼Œå…¶ä»–å…ƒç´ å¡«å…… 0 çš„æ•°ç»„ã€‚ï¼ˆè¯¥è¯­æ³•åœ¨ C++ ä¸­å·²ä¸å¯ç”¨ï¼‰</p>
<hr>
<p>å¦‚å‰æ–‡æ‰€è®²ï¼Œåƒ extern uint64 sys_trace(void); è¿™æ ·çš„ç”³æ˜æ˜¯åœ¨ kernel&#x2F;syscall.c ä¸­çš„ï¼Œè€Œå®ç°åœ¨ kernel&#x2F;sysproc.c ä¸­ï¼Œæˆ‘ä»¬éœ€è¦åˆ°è¿™ä¸ªæ–‡ä»¶ä¸­éšä¾¿æ·»åŠ ä¸€ä¸ªå®ç°ï¼ˆå…·ä½“çš„å®ç°åœ¨ä¸‹æ–‡è®²ï¼‰ã€‚</p>
<p>æ³¨æ„åœ¨è¿™é‡Œåªæ˜¯æ·»åŠ äº†æµ‹è¯•ä»£ç ï¼Œç”¨äºæµ‹è¯•traceæ˜¯å¦èƒ½æ­£ç¡®ç¼–è¯‘ã€‚å…·ä½“å®ç°åœ¨åé¢è¿˜ä¼šå†™åˆ°ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152213277.png" alt="image-20230915221338187"></p>
<p>åœ¨æœ€åæ·»åŠ ä¸Šé¢çš„ä»£ç ã€‚ä¿å­˜é€€å‡ºï¼Œå†é‡æ–°make qemuï¼Œå°±å¯ä»¥æ­£å¸¸ç¼–è¯‘äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152215059.png" alt="image-20230915221550839"></p>
<p>æµ‹è¯•ä¸€ä¸‹traceå‘½ä»¤ï¼Œtrace 32 grep hello READMEï¼Œçœ‹åˆ°hello from trace å³<strong>ä»£è¡¨æˆåŠŸ</strong>ã€‚ï¼ˆæ˜¯ä¸æ˜¯å¾ˆçœ¼ç†Ÿï¼Œå°±æ˜¯ä¸Šé¢sys_traceå‡½æ•°çš„printfï¼‰</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152216021.png" alt="image-20230915221645821"></p>
<p>ctrl a  x é€€å‡ºxv6</p>
<hr>
<p><strong>hhåˆšåˆšåªæ˜¯åœ¨å®ç°traceå‘½ä»¤èƒ½å¤Ÿç¼–è¯‘ï¼Œä½†è¿˜æ²¡æœ‰å®ç°å®ƒçš„è¿½è¸ªåŠŸèƒ½ã€‚ã€‚ã€‚@__@</strong></p>
<hr>
<p><strong>æ¥ä¸‹æ¥é’ˆå¯¹traceçš„è¿½è¸ªåŠŸèƒ½è¿›è¡Œå®ç°ã€‚</strong></p>
<p>traceè¿½è¸ªåŠŸèƒ½ï¼Œæƒ³è¦äº†è§£ä½¿ç”¨äº†å“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼Œå…¶å®å¯ä»¥ç›´æ¥åœ¨ç³»ç»Ÿè°ƒç”¨çš„ä¸­è½¬å‡½æ•°ä¸­åšä¸€äº›æ‰‹è„šï¼Œå› ä¸ºç”¨æˆ·ç¨‹åºæƒ³è¦ä½¿ç”¨ä»»ä½•çš„ç³»ç»ŸæœåŠ¡éƒ½éœ€è¦ç»è¿‡è¿™ä¸ªå‡½æ•°ã€‚é‚£ä¹ˆå°±å¯ä»¥ç›´æ¥åœ¨è¿™ä¸ªå‡½æ•°ä¸­è¾“å‡º trace çš„ä¿¡æ¯äº†ã€‚</p>
<p>ä½†æ˜¯å¯èƒ½åŒæ—¶æœ‰å¾ˆå¤šä¸ªè¿›ç¨‹éƒ½åœ¨ä½¿ç”¨ç³»ç»Ÿè°ƒç”¨ï¼Œè€Œç›´æ¥åœ¨ <code>syscall()</code> å‡½æ•°ä¸­è¾“å‡ºçš„è¯ï¼Œå°±ä¸åªæ˜¯è¾“å‡ºä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨çš„ç³»ç»Ÿè°ƒç”¨äº†ã€‚</p>
<p>è€Œä¸”ç›´æ¥è¾“å‡ºçš„è¯ä¹Ÿä¸ç¬¦åˆ lab ä¸­å¯¹ mask çš„è¦æ±‚ï¼ˆä¹Ÿå°±æ˜¯æŒ‡å®šè¾“å‡ºå“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼‰ã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦æœ‰ä¸€ç§æ–¹æ³•æ¥ç¡®å®šå½“å‰çš„è¿›ç¨‹æ˜¯å¦å¸Œæœ› traceï¼Œå¦‚æœå¸Œæœ›ï¼Œé‚£æ˜¯å¸Œæœ› trace å“ªäº›ç³»ç»Ÿè°ƒç”¨ï¼ˆä¹Ÿå°±æ˜¯ maskï¼‰ã€‚è¦è¾¾åˆ°è¿™ä¸ªè¦æ±‚æˆ‘ä»¬å¯ä»¥ç›´æ¥å»ç»™æè¿°è¿›ç¨‹çš„ç»“æ„ä½“åŠ ä¸€ä¸ª mask å±æ€§ã€‚è€Œå®šä¹‰è¿›ç¨‹çš„ç»“æ„ä½“å°±æ˜¯ <code>struct proc</code>ï¼Œåœ¨ <code>kernel/proc.h</code> è¿™ä¸ªæ–‡ä»¶ä¸­ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152224830.png" alt="image-20230915222405713"></p>
<p>åœ¨æœ€åæ·»åŠ ä¸Šé¢çš„ä»£ç   int  trace_maskã€‚</p>
<p>è¿™æ ·ï¼Œåœ¨ä¸­è½¬å‡½æ•° <code>syscall()</code> ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ£€æµ‹å½“å‰è¿›å…¥å†…æ ¸çš„è¿™ä¸ªè¿›ç¨‹çš„ <code>trace_mask</code> å°±è¡Œäº†ã€‚å¦‚æœå‘ç°è¿™ä¸ªè¿›ç¨‹å¸Œæœ›è¿½è¸ªç°åœ¨å®ƒè°ƒç”¨çš„è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥è¾“å‡ºäº†ã€‚è¿™æ ·ä¸€æ¥ï¼Œå°±ä¸ä¼šéšä¾¿ç¢°åˆ°ä¸€ä¸ªè¿›ç¨‹å°±è¾“å‡ºä¿¡æ¯äº†ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¿®æ”¹è¿‡çš„ <code>syscall()</code> å‡½æ•°ï¼Œåœ¨ <code>kernel/syscall.c</code> ä¸­ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">const static *syscall_names[] &#x3D; &#123;
  &quot;fork&quot;, &quot;exit&quot;, &quot;wait&quot;, &quot;pipe&quot;, &quot;read&quot;, &quot;kill&quot;, &quot;exec&quot;, &quot;fstat&quot;, &quot;chdir&quot;, &quot;dup&quot;,
  &quot;getpid&quot;, &quot;sbrk&quot;, &quot;sleep&quot;, &quot;uptime&quot;, &quot;open&quot;, &quot;write&quot;, &quot;mknod&quot;, &quot;unlink&quot;, &quot;link&quot;,
  &quot;mkdir&quot;, &quot;close&quot;, &quot;trace&quot;, &quot;sysinfo&quot;
&#125;;

void
syscall(void)
&#123;
    int num;
    struct proc *p &#x3D; myproc();  &#x2F;&#x2F; myproc() ä¼šç»™å‡ºå½“å‰è°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„è¿›ç¨‹
    num &#x3D; p-&gt;trapframe-&gt;a7;     &#x2F;&#x2F; å½“å‰è¿›ç¨‹å¸Œæœ›è°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨
    if (num &gt; 0 &amp;&amp; num &lt; NELEM(syscalls) &amp;&amp; syscalls[num]) &#123;
        p-&gt;trapframe-&gt;a0 &#x3D; syscalls[num](); &#x2F;&#x2F; é€šè¿‡ num æ‰¾åˆ°éœ€è¦è°ƒç”¨å“ªä¸ªå‡½æ•°
        &#x2F;&#x2F; è¿™ä¸ª a0 å‚¨å­˜äº†ç³»ç»Ÿè°ƒç”¨çš„è¿”å›å€¼
        int trace_mask &#x3D; p-&gt;trace_mask;     &#x2F;&#x2F; æ£€æŸ¥è¿™ä¸ªè¿›ç¨‹çš„ trace mask
        if ((trace_mask &gt;&gt; num) &amp; 1) &#123;      &#x2F;&#x2F; å¦‚æœå½“å‰è¿™ä¸ªç³»ç»Ÿè°ƒç”¨æ˜¯è¿›ç¨‹å¸Œæœ›è¿½è¸ªçš„ï¼Œé‚£å°±è¾“å‡º
          &#x2F;&#x2F; 3: syscall read -&gt; 1023 æ˜¯ lab ä¸­è¦æ±‚çš„æ ¼å¼ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹ŸæŒ‰ç…§è¿™ä¸ªæ ¼å¼è¾“å‡º
          &#x2F;&#x2F; è¿™é‡Œçš„ 3 æ˜¯è¿›ç¨‹å·ï¼Œread æ˜¯è°ƒç”¨çš„ç³»ç»Ÿè°ƒç”¨çš„åå­—ï¼Œ1023 æ˜¯è°ƒç”¨è¿‡åçš„è¿”å›å€¼ã€‚
          printf(&quot;%d: syscall %s -&gt; %d\n&quot;, p-&gt;pid, syscall_names[num - 1], p-&gt;trapframe-&gt;a0);
        &#125;
    &#125; else &#123;
        printf(&quot;%d %s: unknown sys call %d\n&quot;, p-&gt;pid, p-&gt;name, num);
        p-&gt;trapframe-&gt;a0 &#x3D; -1;
    &#125;
&#125;</code></pre>

<p>ä¸Šé¢ä»£ç ï¼Œæ–°å¢äº†syscall_names[]æ•°ç»„ï¼Œå†å¯¹syscallå‡½æ•°è¿›è¡Œäº†ä¿®æ”¹ï¼›ï¼ˆå¤åˆ¶ç²˜è´´å¤±æ•ˆæ—¶é‡å¯è™šæ‹Ÿæœºå³å¯è§£å†³ï¼‰</p>
<p>ä¿®æ”¹ä¹‹åå¦‚ä¸‹ï¼šï¼ˆæ–°å¢syscall_names[]æ•°ç»„ï¼Œè¿˜æœ‰151-153è¡Œï¼‰</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152248588.png" alt="image-20230915224756479"></p>
<p>ä¸è¿‡ï¼Œæ¯ä¸ªè¿›ç¨‹çš„ <code>trace_mask</code> ä¹Ÿä¸æ˜¯å‡­ç©ºå‡ºç°çš„ï¼Œåªæœ‰è°ƒç”¨äº† trace è¿™ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œæˆ‘ä»¬æ‰ä¼šç»™è¿›ç¨‹å¢åŠ ä¸€ä¸ª <code>trace_mask</code>ã€‚</p>
<p>æ‰€ä»¥è‚¯å®šä¸èƒ½åƒåˆšæ‰é‚£æ ·åœ¨å®ç° <code>sys_trace()</code> æ—¶ï¼Œç›´æ¥è¾“å‡ºä¸€ä¸ª hello from trace\texttt{hello from trace}hello from traceã€‚</p>
<p>ä¸‹é¢å°±æ˜¯ä¿®æ”¹åçš„ <code>sys_trace</code> çš„å®ç°ã€‚</p>
<p>vim  sysproc.c    ä¿®æ”¹ä¹‹å‰çš„ä»£ç ï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152345706.png" alt="image-20230915234534627"></p>
<p>æ³¨æ„è¿™é‡Œï¼šï¼šä¸è¦æŒ‰ç½‘ä¸Šçš„æ•™ç¨‹å†™æˆ if(argint(0, &amp;mask)) &lt; 0)ã€‚ã€‚ã€‚åé¢æŠ¥é”™æ‰¾ç­”æ¡ˆæäº†åŠä¸ªå°æ—¶ï¼Œé—®äº†gptæ‰çŸ¥é“ã€‚è¿™ä¸ªargintè¿”å›å€¼æ˜¯voidï¼Œä¸èƒ½è¿›è¡Œæ¡ä»¶åˆ¤æ–­ã€‚æ‰€ä»¥è¦å•ç‹¬å†™å‡ºæ¥ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152350163.png" alt="image-20230915235008058"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">uint64 
sys_trace()&#123;
  int mask;
  argint(0, &amp;mask)  &#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼ï¼
  if(mask) &lt; 0)&#123;
    &#x2F;&#x2F;ä»ç”¨æˆ·æ€è¯»å–ç¬¬ 0 ä¸ª 32 ä½çš„æ•°æ®
    return - 1;
  &#125;
  struct proc *cur_proc &#x3D; myproc(); &#x2F;&#x2F; è¿›è¡Œç³»ç»Ÿè°ƒç”¨çš„è¿™ä¸ªè¿›ç¨‹
  cur_proc-&gt;trace_mask &#x3D; mask;
  return 0;
&#125;</code></pre>

<p><em>æœ¬è´¨ä¸Šå¾ˆç®€å•ï¼Œæˆ‘ä»¬åœ¨ç”¨æˆ·æ€è°ƒç”¨ <code>trace()</code> æ—¶ï¼Œä¼šä¼ è¿›å»ä¸€ä¸ª <code>mask</code>ï¼Œè€Œç°åœ¨è¿™ä¸ªç³»ç»Ÿè°ƒç”¨å®é™…ä¸Šå°±æ˜¯æŠŠä¼ è¿›æ¥çš„è¿™ä¸ª mask èµ‹å€¼åˆ°å½“å‰çš„ <code>struct proc</code> ä¸Šã€‚è¿™æ ·ä¹‹åç»è¿‡ä¸­è½¬å‡½æ•°æ—¶ï¼Œå°±å¯ä»¥çŸ¥é“è¦è¿½è¸ªå“ªäº›ç³»ç»Ÿè°ƒç”¨äº†ã€‚</em></p>
<p><em>æ³¨æ„è¿™é‡Œçš„ <code>argint(0, &amp;mask)</code> è¿™å¥è¯ï¼Œå…¶ç”¨å¤„æ˜¯è¯»å–ç¬¬ä¸€ä¸ª 323232 ä½çš„å‚æ•°ã€‚</em></p>
<p>æœ€åæ”¶å°¾å·¥ä½œçš„å‡½æ•°ï¼ˆæ„Ÿè§‰æœ‰ç‚¹åƒæ˜¯ C++ é‡Œçš„ææ„å‡½æ•°ï¼‰å°±æ˜¯ <code>freeproc()</code>ï¼Œä¹Ÿå’Œ <code>allocproc()</code> ä¸€èµ·ï¼Œåœ¨ <code>kernel/proc.c</code> è¿™ä¸ªæ–‡ä»¶ä¸­ã€‚é‚£ä¹ˆæˆ‘ä»¬ç›´æ¥åœ¨æœ€åæ¥ä¸€å¥ <code>p-&gt;trace_mask = 0;</code> å°±å¯ä»¥äº†ã€‚</p>
<p>vim  kernel&#x2F;proc.c  </p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152256360.png" alt="image-20230915225635294"></p>
<p>åˆ°è¿™é‡Œï¼Œç¦»å®Œæˆè¿™ä¸ª lab å°±åªå‰©æœ€åä¸€æ­¥äº†ã€‚</p>
<blockquote>
<p>  The trace system call should enable tracing for the process that  calls it and any children that it subsequently forks, but should not  affect other processes.</p>
</blockquote>
<p>ä¹Ÿå°±æ˜¯å®ç°è¿™å¥è¯è¯´çš„åŠŸèƒ½ï¼Œå¦‚æœæˆ‘ä»¬çš„çˆ¶è¿›ç¨‹æœ‰ <code>trace_mask</code>ï¼Œå­è¿›ç¨‹ä¹Ÿéœ€è¦æœ‰ç›¸åŒçš„ã€‚å› ä¸ºåˆ›å»ºå­è¿›ç¨‹éƒ½éœ€è¦ç”¨ <code>fork()</code>ï¼Œé‚£ç›´æ¥å»æ”¹ <code>fork</code> çš„æºç å°±å¥½äº†ï¼š</p>
<p>vimè¿›å…¥ proc.cï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152303080.png" alt="image-20230915230305961"></p>
<p><code>fork()</code> çš„å…·ä½“å®ç°å’Œä¸Šé¢çš„ä¸¤ä¸ªå‡½æ•°ä¸€æ ·ï¼Œè¿˜æ˜¯åœ¨ <code>kernel/proc.c</code> ä¸­ï¼ˆæ¯•ç«Ÿå’Œè¿›ç¨‹æœ‰å…³ï¼‰ã€‚</p>
<p>å¯ä»¥çœ‹åˆ°ï¼Œç¬¬ä¸€è¡Œå®šä¹‰äº†ä¸¤ä¸ª <code>struct proc</code>ï¼Œä¸€ä¸ªæ˜¯ <code>np</code>ï¼Œä¸€ä¸ªæ˜¯ <code>p</code>ã€‚å› ä¸ºä»£ç ä¸­çš„æ³¨é‡Šï¼Œæ‰€ä»¥å¾ˆæ˜æ˜¾å¯ä»¥çœ‹å‡ºæ¥ï¼Œè¿™ä¸ª <code>np</code> å°±æ˜¯æ–°çš„è¿›ç¨‹ï¼Œé‚£æˆ‘ä»¬å°±å®Œå…¨ä¸ç”¨ç®¡è¿™é‡Œä¸€å †çœ‹ä¸æ‡‚çš„ä¸œè¥¿äº†ï¼Œç›´æ¥åœ¨ä¸­é—´æ¥ä¸€ä¸ª <code>np-&gt;trace_mask = p-&gt;trace_mask</code>ã€‚</p>
<p>ç»ˆäº</p>
<p>ç»ˆäº</p>
<p>ã€‚ã€‚ã€‚ã€‚&#x2F;ã€‚&#x2F;ã€‚&#x2F;ã€‚ï¼Œã€‚ï¼Œ&#x2F;ã€‚ï¼Œã€‚&#x2F;ï¼Œã€‚ã€‚ã€‚ï¼Œï¼›ï¼Œâ€˜ã€‚ã€‚ã€‚&#x2F;&#x2F;</p>
<p>&#x3D;&#x3D;å®Œç»“æ’’èŠ±&#x3D;&#x3D;</p>
<p>ç”¨æ—¶ 4hour</p>
<p>æ„Ÿæƒ³æ˜¯å¥½ç´¯ï¼Œã€‚ã€‚ã€‚ã€‚&#x2F;å“­&#x2F;  0_0  O.O  o_o</p>
<hr>
<p>å®é™…ä¸Šæ“ä½œèµ·æ¥ä¸ç”¨é•¿æ—¶é—´ï¼Œç›´æ¥ä¿®æ”¹è¿™é‡Œçš„æŒ‡å®šæ–‡ä»¶çš„ä»£ç å°±å¥½ï¼Œä½†æ˜¯æ•´ä¸ªå­¦ä¹ è¿‡ç¨‹è¿˜æ˜¯å¾ˆé‡è¦çš„ï¼Œç‰¹åˆ«æ˜¯å‰é¢çš„gdbè°ƒè¯•ï¼Œè¿˜æœ‰çœ‹xv6æ–‡æ¡£ï¼Œç†è§£ç³»ç»Ÿè°ƒç”¨çš„æ•´ä¸ªè¿‡ç¨‹ï¼Œéƒ½æ˜¯è›®é‡è¦çš„ã€‚<br><a target="_blank" rel="noopener" href="https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab2-system%20calls.md">https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab2-system%20calls.md</a></p>
<p>åç»­ï¼šçœŸå‘å•Šç½‘ä¸Šçš„æ•™ç¨‹ã€‚è¿˜ä»¥ä¸ºæ²¡å•¥é—®é¢˜äº†ï¼Œç»“æœmake qemuä¸€è·‘å°±æŠ¥é”™äº†ã€‚å°±æ˜¯åœ¨sysproc.cé‡Œé¢çš„argintå‡½æ•°æ˜¯æ²¡æœ‰è¿”å›å€¼çš„ï¼Œæ•™ç¨‹çš„ä»£ç é”™è¯¯çš„åœ¨ifæ¡ä»¶å¥é‡Œé¢è¿›è¡Œåˆ¤æ–­äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152352456.png" alt="image-20230915235243247"></p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152358000.png" alt="image-20230915235808942"></p>
<p>ç»ˆäºèƒ½è·‘å‡ºäº†äº†ã€‚</p>
<p>æ—¶é—´å·²ç»æ˜¯2023&#x2F;9&#x2F;15 23:52äº†ã€‚</p>
<p>è¸©å‘æ—¥è®°ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;&#x2F;  &#x2F;kernel&#x2F;sysproc.c&#x2F;sys_trace()
uint64
sys_trace()
&#123;
  int mask;
  argint(0, &amp;mask)&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;&#x2F;ï¼ï¼ï¼ï¼è¿™é‡Œè¦å•ç‹¬åˆ†å‡ºæ¥
  if (mask) &lt; 0)
      return -1;

  struct proc *pro &#x3D; myproc();
  printf(&quot;trace pid: %d\n&quot;, pro-&gt;pid);
  pro-&gt;trace_mask &#x3D; mask;

  return 0;
&#125; </code></pre>





<h2 id="Lab03-1-page-table"><a href="#Lab03-1-page-table" class="headerlink" title="Lab03-1:page table"></a>Lab03-1:page table</h2><p>å‚è€ƒåšå®¢ï¼š<a target="_blank" rel="noopener" href="https://ttzytt.com/2022/07/xv6_note/">https://ttzytt.com/2022/07/xv6_note/</a></p>
<p><a target="_blank" rel="noopener" href="https://ttzytt.com/2022/07/xv6_lab3_record/">https://ttzytt.com/2022/07/xv6_lab3_record/</a></p>
<p>To help you learn about RISC-V page tables, and perhaps to aid future debugging, your first task is to write a function that prints  the contents of a page table. Now when you start xv6 it should print output like this, describing the page table of the first process at the point when it has just finished <code>exec()</code>ing <code>init</code>:   </p>
<p>ä¸ºäº†å¸®åŠ©æ‚¨äº†è§£RISC-Vé¡µè¡¨ï¼Œä¹Ÿè®¸æ˜¯ä¸ºäº†å¸®åŠ©å°†æ¥è¿›è¡Œè°ƒè¯•ï¼Œæ‚¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡æ˜¯ç¼–å†™ä¸€ä¸ªæ‰“å°é¡µè¡¨å†…å®¹çš„å‡½æ•°ã€‚</p>
<p>å®šä¹‰ä¸€ä¸ªåä¸º <code>vmprint()</code> çš„å‡½æ•°ã€‚å®ƒåº”è¯¥æ¥å—ä¸€ä¸ª <code>pagetable_t</code> å‚æ•°ï¼Œå¹¶ä»¥ä¸‹é¢æè¿°çš„æ ¼å¼æ‰“å°è¯¥åˆ†é¡µè¡¨ã€‚åœ¨ exec.c ä¸­æ’å…¥ <code>if(p-&gt;pid==1) vmprint(p-&gt;pagetable)</code> çš„ <code>return argc</code> å‰é¢ï¼Œä»¥æ‰“å°ç¬¬ä¸€ä¸ªè¿›ç¨‹çš„é¡µè¡¨ã€‚</p>
<p>ç°åœ¨å½“ä½ å¯åŠ¨ xv6 æ—¶ï¼Œå®ƒåº”è¯¥åƒè¿™æ ·æ‰“å°è¾“å‡ºï¼Œæè¿°ç¬¬ä¸€ä¸ªè¿›ç¨‹åœ¨åˆšåˆšå®Œæˆ <code>exec()</code> ing <code>init</code> æ—¶çš„é¡µè¡¨ï¼š</p>
<pre class="line-numbers language-none"><code class="language-none">page table 0x0000000087f6e000
..0: pte 0x0000000021fda801 pa 0x0000000087f6a000
.. ..0: pte 0x0000000021fda401 pa 0x0000000087f69000
.. .. ..0: pte 0x0000000021fdac1f pa 0x0000000087f6b000
.. .. ..1: pte 0x0000000021fda00f pa 0x0000000087f68000
.. .. ..2: pte 0x0000000021fd9c1f pa 0x0000000087f67000
..255: pte 0x0000000021fdb401 pa 0x0000000087f6d000
.. ..511: pte 0x0000000021fdb001 pa 0x0000000087f6c000
.. .. ..510: pte 0x0000000021fdd807 pa 0x0000000087f76000
.. .. ..511: pte 0x0000000020001c0b pa 0x0000000080007000
</code></pre>

<p>ç¬¬ä¸€è¡Œæ˜¾ç¤º çš„ <code>vmprint</code> å‚æ•°ã€‚ä¹‹åï¼Œæ¯ä¸ª PTE éƒ½æœ‰ä¸€è¡Œï¼ŒåŒ…æ‹¬å¼•ç”¨æ ‘ä¸­æ›´æ·±å¤„çš„é¡µè¡¨é¡µé¢çš„ PTEã€‚æ¯æ¡ PTE çº¿éƒ½ç¼©è¿›äº†ä¸€ä¸ªæ•°å­— <code>&quot; ..&quot;</code> ï¼Œè¡¨ç¤ºå…¶åœ¨æ ‘ä¸­çš„æ·±åº¦ã€‚æ¯ä¸ª PTE è¡Œåœ¨å…¶é¡µè¡¨é¡µä¸­æ˜¾ç¤º PTE ç´¢å¼•ã€pte ä½ä»¥åŠä» PTE ä¸­æå–çš„ç‰©ç†åœ°å€ã€‚ä¸è¦æ‰“å°æ— æ•ˆçš„  PTEã€‚åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œé¡¶çº§é¡µè¡¨é¡µå…·æœ‰æ¡ç›® 0 å’Œ 255 çš„æ˜ å°„ã€‚æ¡ç›® 0 çš„ä¸‹ä¸€çº§ä»…æ˜ å°„ç´¢å¼• 0ï¼Œè¯¥ç´¢å¼• 0 çš„ä¸‹ä¸€çº§æ˜ å°„äº†æ¡ç›® 0ã€1 å’Œ 2ã€‚</p>
<p>Some hints:</p>
<pre class="line-numbers language-none"><code class="language-none">1.å°†vmprint()æ”¾è¿›kernel&#x2F;vm.c
2.ä½¿ç”¨æ–‡ä»¶ kernel&#x2F;riscv.h æœ«å°¾çš„å®
3.åœ¨ kernel&#x2F;defs.h ä¸­å®šä¹‰åŸå‹ vmprint ï¼Œä»¥ä¾¿å¯ä»¥ä» exec.c è°ƒç”¨å®ƒ
4.å¯ä»¥å‚ç…§freewalk.cè¿›è¡Œé€’å½’éå†
5.%p åœ¨ printf è°ƒç”¨ä¸­ä½¿ç”¨ä»¥æ‰“å°å‡ºå®Œæ•´çš„ 64 ä½åå…­è¿›åˆ¶ PTE å’Œåœ°å€ï¼Œå¦‚ç¤ºä¾‹ä¸­æ‰€ç¤º</code></pre>



<p>å®ç°ä»£ç :</p>
<p>å…ˆåˆ‡æ¢åˆ†æ”¯</p>
<pre class="line-numbers language-none"><code class="language-none">git checkout pgtb
make clean</code></pre>



<pre class="line-numbers language-c" data-language="c"><code class="language-c">void 
vmprint(pagetable_t pagetable, uint dep)&#123;
  if(dep &#x3D;&#x3D; 0)
    printf(&quot;page table %p\n&quot;, pagetable);
  for(int i &#x3D; 0; i &lt; 512; i++)&#123;
    pte_t pte &#x3D; pagetable[i];
    if(pte &amp; PTE_V)&#123;
      for(int j &#x3D; 0; j &lt; dep; j++)
        printf(&quot;.. &quot;);
      uint64 child &#x3D; PTE2PA(pte);
      printf(&quot;..%d: pte %p pa %p\n&quot;, i, pte, child);
      if(dep &lt; 2)
        &#x2F;&#x2F; å¦‚æœå±‚æ•°ç­‰äº 2 å°±ä¸éœ€è¦ç»§ç»­é€’å½’äº†ï¼Œå› ä¸ºè¿™æ˜¯å¶å­èŠ‚ç‚¹
        vmprint((pagetable_t) child, dep + 1);
    &#125;
  &#125; 
&#125;</code></pre>

<p>å¯¹äºæ¯ä¸ª <code>pagetable</code>ï¼Œæœ€å¤šæœ‰ 512 ä¸ªèŠ‚ç‚¹ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±ä¾æ¬¡éå†å®ƒä»¬ã€‚å¦‚æœå‘ç°è¿™ä¸ªé¡µè¡¨æ˜¯å·²åˆ†é…çš„ï¼Œä¹Ÿå°±æ˜¯ç¬¦åˆ <code>pte &amp; PTE_V == 1</code> çš„ï¼Œæˆ‘ä»¬å°±ç»§ç»­é€’å½’ã€‚</p>
<p>åœ¨æ‰“å°çš„æ—¶å€™ï¼Œæˆ‘ä»¬å…ˆéœ€è¦æ‰“å°å‡º <code>dep + 1</code> ä¸ª <code>..</code>ï¼Œç„¶åå†æ‰“å°å‡º pte å’Œ paã€‚</p>
<p>è¿™é‡ŒæŒ‡çš„ pte æŒ‡çš„æ˜¯ç›´æ¥è¯»å–é¡µè¡¨é¡¹çš„ç»“æœï¼Œè€Œ pa æ˜¯å»æ‰é¡µè¡¨é¡¹ä¸­çš„æ ‡å¿—ä½åå¾—åˆ°çš„ç‰©ç†åœ°å€ï¼Œæˆ‘ä»¬é€šè¿‡è¿™ä¸ªç‰©ç†åœ°å€å¯ä»¥æ‰¾åˆ°ä¸‹ä¸€å±‚çš„é¡µè¡¨é¡¹æˆ–æ˜¯é¡µå¸§ã€‚</p>
<p>æ³¨æ„å¯ä»¥è¿™ä¹ˆ <code>pte_t pte = pagetable[i];</code> å†™æ˜¯å› ä¸ºï¼Œpa æŒ‡å‘çš„å®é™…ä¸Šæ˜¯è¿™ä¸ªå­é¡µè¡¨çš„ç¬¬ä¸€ä¸ªå…ƒç´ ï¼Œè€Œ <code>pagetable[i]</code> å’Œ <code>*(pagetable + i)</code> æ˜¯ç­‰ä»·çš„ï¼Œä¹Ÿå°±æ˜¯å»è®¿é—®ç¬¬ i ä¸ªé¡µè¡¨ã€‚</p>
<p>ç¬¬ä¸€æ­¥ï¼šåœ¨&#x2F;kernel&#x2F;vm.c  æœ€åæ–°å¢ä»£ç æ®µï¼Œä¿å­˜é€€å‡º</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309162323397.png" alt="image-20230916232306105"></p>
<p>ç¬¬äºŒæ­¥ï¼šç„¶ååœ¨kernel&#x2F;exec.cä¸­æ‰¾åˆ°execå‡½æ•°ï¼Œæ·»åŠ ä»£ç æ®µ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">if(p-&gt;pid &#x3D;&#x3D; 1)
    vmprint(p-&gt;pagetable, 0);</code></pre>

<p>vimæ“ä½œå¿«æ·é”®ï¼š æŸ¥æ‰¾ &#x2F;xxx  ï¼ˆè¾“å…¥&#x2F;ä¹‹åè¾“å…¥è¦æŸ¥æ‰¾çš„å†…å®¹ï¼Œæ¯”å¦‚è¦æŸ¥æ‰¾execï¼Œå°±è¾“å…¥&#x2F;exec ï¼ŒæŸ¥è¯¢ä¸‹ä¸€ä¸ªæ—¶ï¼Œå…ˆæŒ‰å›è½¦ï¼Œå†æŒ‰enterï¼‰</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309170911731.png" alt="image-20230917091101655"></p>
<p>&#x2F;kernel&#x2F;defs.h    åœ¨&#x2F;&#x2F;vm.cä¸‹é¢æ–°å¢ ä¸€è¡Œ  vmprint(pagetable_t,uint dep); ä¸ºäº†execå¯ä»¥è°ƒç”¨ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309162343273.png"></p>
<p>æœ€åç¼–è¯‘ make qemuå³å¯ã€‚					</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309162345802.png" alt="image-20230916234541422"></p>
<p>ä¸€äº›è¡¥å……ï¼š</p>
<p><strong>pagetable_t</strong>ï¼š</p>
<p>åœ¨ xv6 æ“ä½œç³»ç»Ÿä¸­ï¼Œ<code>pagetable_t</code> ç»“æ„ç”¨äºè¡¨ç¤ºé¡µè¡¨ã€‚å®ƒæ˜¯ä¸€ä¸ªåŒ…å« 512 ä¸ª <code>pte_t</code> å…ƒç´ çš„æ•°ç»„ã€‚</p>
<p><code>pagetable_t</code> çš„å®šä¹‰ä½äº <code>kernel/riscv.h</code> æ–‡ä»¶ä¸­ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;&#x2F; Page table descriptor entry
typedef uint64_t pte_t;

&#x2F;&#x2F; Page table
typedef struct &#123;
  pte_t ent[512];
&#125; pagetable_t;</code></pre>

<p>ä¸Šè¿°å®šä¹‰ä¸­ï¼Œ<code>pte_t</code> æ˜¯ä¸€ä¸ª 64 ä½çš„æ— ç¬¦å·æ•´æ•°ç±»å‹ï¼Œç”¨äºè¡¨ç¤ºé¡µè¡¨é¡¹ï¼ˆpage table entryï¼‰ã€‚æ¯ä¸ªé¡µè¡¨é¡¹åŒ…å«æœ‰å…³è™šæ‹Ÿåœ°å€å’Œç‰©ç†åœ°å€ä¹‹é—´æ˜ å°„å…³ç³»çš„ä¿¡æ¯ã€‚è€Œ <code>pagetable_t</code> ç»“æ„ä½“åˆ™ç”±åŒ…å« 512 ä¸ª <code>pte_t</code> å…ƒç´ çš„æ•°ç»„ <code>ent</code> ç»„æˆï¼Œå³ <code>ent</code> æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º 512 çš„ <code>pte_t</code> ç±»å‹çš„æ•°ç»„ã€‚</p>
<p>é€šè¿‡ä½¿ç”¨è¿™ç§ç»“æ„ï¼Œxv6 èƒ½å¤Ÿçµæ´»åœ°ç®¡ç†å’Œè®¿é—®é¡µè¡¨ï¼Œä»¥å®ç°è™šæ‹Ÿåœ°å€åˆ°ç‰©ç†åœ°å€çš„æ˜ å°„ã€‚</p>
<h2 id="Lab04-file-system"><a href="#Lab04-file-system" class="headerlink" title="Lab04-file system"></a>Lab04-file system</h2><p>xv6ä¸­æ–‡æ‰‹å†Œåœ°å€ï¼š<a target="_blank" rel="noopener" href="http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/c8/s0.html">http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/c8/s0.html</a></p>
<p>labåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2020/labs/fs.html">https://pdos.csail.mit.edu/6.S081/2020/labs/fs.html</a></p>
<p>å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://ttzytt.com/2022/08/xv6_lab10_record/">https://ttzytt.com/2022/08/xv6_lab10_record/</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab9-file%20system.md">https://github.com/whileskies/xv6-labs-2020/blob/main/doc/Lab9-file%20system.md</a></p>
<hr>
<p>xv6bookï¼š</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/c8/s0.html">http://xv6.dgs.zone/tranlate_books/book-riscv-rev1/c8/s0.html</a></li>
<li>æ–‡ä»¶ç³»ç»Ÿéœ€è¦ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„æ¥è¡¨ç¤ºç›®å½•å’Œæ–‡ä»¶åç§°æ ‘ï¼Œè®°å½•ä¿å­˜æ¯ä¸ªæ–‡ä»¶å†…å®¹çš„å—çš„æ ‡è¯†ï¼Œä»¥åŠè®°å½•ç£ç›˜çš„å“ªäº›åŒºåŸŸæ˜¯ç©ºé—²çš„ã€‚</li>
<li>æ–‡ä»¶ç³»ç»Ÿå¿…é¡»æ”¯æŒå´©æºƒæ¢å¤ï¼ˆcrash recoveryï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœå‘ç”Ÿå´©æºƒï¼ˆä¾‹å¦‚ï¼Œç”µæºæ•…éšœï¼‰ï¼Œæ–‡ä»¶ç³»ç»Ÿå¿…é¡»åœ¨é‡æ–°å¯åŠ¨åä»èƒ½æ­£å¸¸å·¥ä½œã€‚é£é™©åœ¨äºå´©æºƒå¯èƒ½ä¼šä¸­æ–­ä¸€ç³»åˆ—æ›´æ–°ï¼Œå¹¶ä½¿ç£ç›˜ä¸Šçš„æ•°æ®ç»“æ„ä¸ä¸€è‡´ï¼ˆä¾‹å¦‚ï¼Œä¸€ä¸ªå—åœ¨æŸä¸ªæ–‡ä»¶ä¸­ä½¿ç”¨ä½†åŒæ—¶ä»è¢«æ ‡è®°ä¸ºç©ºé—²ï¼‰ã€‚</li>
<li>ä¸åŒçš„è¿›ç¨‹å¯èƒ½åŒæ—¶åœ¨æ–‡ä»¶ç³»ç»Ÿä¸Šè¿è¡Œï¼Œå› æ­¤æ–‡ä»¶ç³»ç»Ÿä»£ç å¿…é¡»åè°ƒä»¥ä¿æŒä¸å˜é‡ã€‚</li>
<li>è®¿é—®ç£ç›˜çš„é€Ÿåº¦æ¯”è®¿é—®å†…å­˜æ…¢å‡ ä¸ªæ•°é‡çº§ï¼Œå› æ­¤æ–‡ä»¶ç³»ç»Ÿå¿…é¡»ä¿æŒå¸¸ç”¨å—çš„å†…å­˜ç¼“å­˜ã€‚</li>
</ul>
<p>å®ç°è¿‡ç¨‹ï¼š</p>
<p>1.vim kernel&#x2F;sh.c  </p>
<p>æ‰¾åˆ°è¿™ä¸‰è¡Œå®å®šä¹‰ï¼š å¯ä»¥é€šè¿‡vimæŸ¥æ‰¾ &#x2F;NDIRECT æ‰¾åˆ°</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171640492.png" alt="image-20230917164033360"></p>
<p>ä¿®æ”¹æˆï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#define NDIRECT 11
#define DINDIRECTI (NDIRECT + 1)
#define NINDIRECT (BSIZE &#x2F; sizeof(uint))
#define MAXFILE (NDIRECT + NINDIRECT + NINDIRECT * NINDIRECT)</code></pre>

<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171642880.png" alt="image-20230917164205815"></p>
<p>2.vim kernrl&#x2F;file.h</p>
<p>æ‰¾åˆ°addrs[NDIECT+1];</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171643389.png" alt="image-20230917164328329"></p>
<p>ä¿®æ”¹æˆuint addrs[NDIRECT+2];</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171645022.png" alt="image-20230917164529946"></p>
<p>3.vim &#x2F;kernel&#x2F;fs.h</p>
<p>æ‰¾åˆ°struct dinodeï¼Œå°†addrs[NDIRECT+1]ä¿®æ”¹æˆ+2</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171648407.png" alt="image-20230917164838340"></p>
<p>4.vim kernel&#x2F;fs.c  æ‰¾åˆ°bmapå‡½æ•°ï¼Œä¿®æ”¹æˆä»¥ä¸‹ä»£ç ï¼š</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171718599.png" alt="image-20230917171828521"></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">static uint
bmap(struct inode *ip, uint bn)
&#123;
  uint addr, addr2, *a, *a2;
  struct buf *bp, *bp2;

  if(bn &lt; NDIRECT)&#123;
    if((addr &#x3D; ip-&gt;addrs[bn]) &#x3D;&#x3D; 0)
      ip-&gt;addrs[bn] &#x3D; addr &#x3D; balloc(ip-&gt;dev);
    return addr;
  &#125;
  bn -&#x3D; NDIRECT;

  if(bn &lt; NINDIRECT)&#123;
    &#x2F;&#x2F; Load indirect block, allocating if necessary.
    if((addr &#x3D; ip-&gt;addrs[NDIRECT]) &#x3D;&#x3D; 0)
      ip-&gt;addrs[NDIRECT] &#x3D; addr &#x3D; balloc(ip-&gt;dev);
    bp &#x3D; bread(ip-&gt;dev, addr);
    a &#x3D; (uint*)bp-&gt;data;
    if((addr &#x3D; a[bn]) &#x3D;&#x3D; 0)&#123;
      a[bn] &#x3D; addr &#x3D; balloc(ip-&gt;dev);
      log_write(bp);
    &#125;
    brelse(bp);
    return addr;
  &#125;
  
  bn -&#x3D; NINDIRECT;

  if(bn &lt; NINDIRECT * NINDIRECT)&#123;
    uint dbn &#x3D; bn &#x2F; NINDIRECT;
    uint dbnoff &#x3D; bn % NINDIRECT;

    &#x2F;&#x2F; Load doubly-indirect block, allocating if necessary.
    if((addr &#x3D; ip-&gt;addrs[DINDIRECTI]) &#x3D;&#x3D; 0)
      ip-&gt;addrs[DINDIRECTI] &#x3D; addr &#x3D; balloc(ip-&gt;dev);
    bp &#x3D; bread(ip-&gt;dev, addr);
    
    a &#x3D; (uint*)bp-&gt;data;
    if((addr2 &#x3D; a[dbn]) &#x3D;&#x3D; 0)&#123;
      a[dbn] &#x3D; addr2 &#x3D; balloc(ip-&gt;dev);
      log_write(bp);
    &#125;
    brelse(bp);

    &#x2F;&#x2F;printf(&quot;addr2: %d\n&quot;, addr2);
    bp2 &#x3D; bread(ip-&gt;dev, addr2);
    a2 &#x3D; (uint*)bp2-&gt;data;
    if((addr &#x3D; a2[dbnoff]) &#x3D;&#x3D; 0)&#123;
      a2[dbnoff] &#x3D; addr &#x3D; balloc(ip-&gt;dev);
      log_write(bp2);
    &#125;
    brelse(bp2);

    return addr;
  &#125;

  panic(&quot;bmap: out of range&quot;);
&#125;</code></pre>

<p>5.vim  kernel&#x2F;fs.c   æ‰¾åˆ°itruncå‡½æ•°</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171720290.png" alt="image-20230917172019225"></p>
<p>ä¿®æ”¹æˆ</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">void
itrunc(struct inode *ip)
&#123;
  int i, j;
  struct buf *bp, *bp2;
  uint *a, *a2;

  for(i &#x3D; 0; i &lt; NDIRECT; i++)&#123;
    if(ip-&gt;addrs[i])&#123;
      bfree(ip-&gt;dev, ip-&gt;addrs[i]);
      ip-&gt;addrs[i] &#x3D; 0;
    &#125;
  &#125;

  if(ip-&gt;addrs[NDIRECT])&#123;
    bp &#x3D; bread(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);
    a &#x3D; (uint*)bp-&gt;data;
    for(j &#x3D; 0; j &lt; NINDIRECT; j++)&#123;
      if(a[j])
        bfree(ip-&gt;dev, a[j]);
    &#125;
    brelse(bp);
    bfree(ip-&gt;dev, ip-&gt;addrs[NDIRECT]);
    ip-&gt;addrs[NDIRECT] &#x3D; 0;
  &#125;

  if(ip-&gt;addrs[DINDIRECTI])&#123;
    bp &#x3D; bread(ip-&gt;dev, ip-&gt;addrs[DINDIRECTI]);
    a &#x3D; (uint*)bp-&gt;data;
    for(i &#x3D; 0; i &lt; NINDIRECT; i++)&#123;
      if(a[i])&#123;
        bp2 &#x3D; bread(ip-&gt;dev, a[i]);
        a2 &#x3D; (uint*)bp2-&gt;data;
        for(j &#x3D; 0; j &lt; NINDIRECT; j++)&#123;
          if(a2[j])
            bfree(ip-&gt;dev, a2[j]);
        &#125;
        brelse(bp2);
        bfree(ip-&gt;dev, a[i]);
      &#125;
    &#125;
    brelse(bp);
    bfree(ip-&gt;dev, ip-&gt;addrs[DINDIRECTI]);
    ip-&gt;addrs[DINDIRECTI] &#x3D; 0;
  &#125;

  ip-&gt;size &#x3D; 0;
  iupdate(ip);
&#125;</code></pre>



<p>6.vim kernel&#x2F;file.c   </p>
<p>æ‰¾åˆ°filewrite() ä¸­çš„int max&#x3D;â€¦  ä¸€è¡Œ</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171721118.png" alt="image-20230917172141017"></p>
<p>ä¿®æ”¹æˆ</p>
<pre class="line-numbers language-none"><code class="language-none">int max &#x3D; ((MAXOPBLOCKS-1-2-2) &#x2F; 2) * BSIZE;</code></pre>



<p>åˆ°æ­¤&#x3D;&#x3D;å®Œç»“æ’’èŠ±&#x3D;&#x3D;</p>
<p>æµ‹è¯•ï¼š</p>
<p>å¯åŠ¨xv6ï¼Œå‘ç°å¯ä»¥æ­£å¸¸å¯åŠ¨ï¼Œè¯´æ˜ä»£ç ä¿®æ”¹æ²¡æœ‰å‡ºç°ç¼–è¯‘é—®é¢˜ã€‚</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171724792.png" alt="image-20230917172440718"></p>
<h2 id="Lab05-net-working"><a href="#Lab05-net-working" class="headerlink" title="Lab05-net working"></a>Lab05-net working</h2><p>å®éªŒåœ°å€ï¼š<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.S081/2020/labs/net.html">https://pdos.csail.mit.edu/6.S081/2020/labs/net.html</a></p>
<p>å­¦ä¹ å‚è€ƒï¼š<a target="_blank" rel="noopener" href="https://ttzytt.com/2022/08/xv6_lab8_record/">https://ttzytt.com/2022/08/xv6_lab8_record/</a>    &#x3D;&#x3D;å¿…çœ‹ï¼ï¼ï¼&#x3D;&#x3D;</p>
<hr>
<p>åˆ‡æ¢åˆ†æ”¯ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">git  stash save &quot;filesys&quot;   
git checkout net 
make clean</code></pre>

<p>å®éªŒä»»åŠ¡ï¼š</p>
<p>å®Œæˆå‡½æ•°e1000_transmit()   and       e1000_recv()</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309172129027.png" alt="image-20230917212916907" style="zoom:67%;" />

<p>è¿™ä¸ªå®éªŒçš„labæè¿°æˆ‘å®åœ¨æ˜¯æœäº†ã€‚ã€‚é•¿é•¿ä¸€å¤§ä¸²ã€‚ã€‚</p>
<h3 id="ä¸€äº›å®šä¹‰"><a href="#ä¸€äº›å®šä¹‰" class="headerlink" title="ä¸€äº›å®šä¹‰"></a>ä¸€äº›å®šä¹‰</h3><p><strong>vim kernel&#x2F;e1000_dev.hå¯ä»¥çœ‹åˆ°æ‰€æœ‰çš„å®å®šä¹‰</strong></p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;&#x2F;TXè¡¨ç¤ºæ•°æ®çš„å‘é€ï¼ˆTransmissionï¼‰ï¼Œè€ŒRXè¡¨ç¤ºæ•°æ®çš„æ¥æ”¶ï¼ˆReceptionï¼‰ã€‚è¿™ä¸ªXå¹¶æ²¡æœ‰ç‰¹å®šçš„æ„ä¹‰ï¼Œåªæ˜¯ç”¨æ¥ä»£è¡¨è¿™ä¸¤ä¸ªæœ¯è¯­çš„é¦–å­—æ¯ã€‚

&#x2F;&#x2F;å‘é€æ–¹
#define E1000_RDH      (0x02810&#x2F;4)  &#x2F;* RX Descriptor Head - RW *&#x2F;   å¤´æŒ‡é’ˆ
#define E1000_RDT      (0x02818&#x2F;4)  &#x2F;* RX Descriptor Tail - RW *&#x2F;   å°¾æŒ‡é’ˆ
#define E1000_RDLEN    (0x02808&#x2F;4)  &#x2F;* RX Descriptor Length - RW *&#x2F; ç¯å½¢é˜Ÿåˆ—çš„é•¿åº¦
&#x2F;&#x2F;æ¥æ”¶æ–¹
#define E1000_TDLEN    (0x03808&#x2F;4)  &#x2F;* TX Descriptor Length - RW *&#x2F;
#define E1000_TDH      (0x03810&#x2F;4)  &#x2F;* TX Descriptor Head - RW *&#x2F;
#define E1000_TDT      (0x03818&#x2F;4)  &#x2F;* TX Descripotr Tail - RW *&#x2F;

    
    
&#x2F;&#x2F; [E1000 3.3.3]
struct tx_desc   &#x2F;&#x2F;å‘é€æ–¹æè¿°ç»“æ„
&#123;
  uint64 addr;
  uint16 length;
  uint8 cso;
  uint8 cmd;
  uint8 status;
  uint8 css;
  uint16 special;
&#125;;

&#x2F;* Receive Descriptor bit definitions [E1000 3.2.3.1] *&#x2F;
#define E1000_RXD_STAT_DD       0x01    &#x2F;* Descriptor Done *&#x2F;  
#define E1000_RXD_STAT_EOP      0x02    &#x2F;* End of Packet *&#x2F;

&#x2F;&#x2F; [E1000 3.2.3]
struct rx_desc   
&#123;
  uint64 addr;       &#x2F;* Address of the descriptor&#39;s data buffer *&#x2F;
  uint16 length;     &#x2F;* Length of data DMAed into data buffer *&#x2F;
  uint16 csum;       &#x2F;* Packet checksum *&#x2F;
  uint8 status;      &#x2F;* Descriptor status *&#x2F;
  uint8 errors;      &#x2F;* Descriptor Errors *&#x2F;
  uint16 special;
&#125;;

</code></pre>

<p>åœ¨e1000.c ä¸­ </p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">#define TX_RING_SIZE 16
static struct tx_desc tx_ring[TX_RING_SIZE] __attribute__((aligned(16)));
static struct mbuf *tx_mbufs[TX_RING_SIZE];

#define RX_RING_SIZE 16
static struct rx_desc rx_ring[RX_RING_SIZE] __attribute__((aligned(16)));
static struct mbuf *rx_mbufs[RX_RING_SIZE];
</code></pre>





<hr>
<h3 id="transmit"><a href="#transmit" class="headerlink" title="transmit()"></a>transmit()</h3><p>å‘é€   e1000_transmit()ï¼š </p>
<p>vim kernel&#x2F;e1000.c    åœ¨æ­¤å¤„å¢åŠ ä»£ç ï¼š</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309181313776.png" alt="image-20230918131324675" style="zoom: 67%;" />



<p>å®ç°ä»£ç ä¸ºï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">int
e1000_transmit(struct mbuf *m)
&#123;
  acquire(&amp;e1000_lock);   &#x2F;&#x2F;è·å–ç½‘ç»œè®¾å¤‡çš„é”ï¼Œç¡®ä¿åœ¨ä½¿ç”¨ç½‘ç»œè®¾å¤‡æ—¶åªæœ‰ä¸€ä¸ªè¿›ç¨‹åœ¨æ‰§è¡Œ

  int tail &#x3D; regs[E1000_TDT];
    &#x2F;*
    tx_ring[tail].status 
   		ç”¨äºè®¿é—® tx_ring æ•°ç»„ä¸­ç´¢å¼•ä¸º tail çš„å…ƒç´ çš„ status å­—æ®µã€‚è¿™ä¸ªå­—æ®µè¡¨ç¤ºä¼ è¾“æè¿°ç¬¦ï¼ˆtransmit descriptorï¼‰çš„çŠ¶æ€ã€‚
	E1000_TXD_STAT_DD 
		æ˜¯ä¸€ä¸ªå¸¸é‡å€¼ï¼Œå®ƒè¡¨ç¤ºä¼ è¾“æè¿°ç¬¦çš„â€œä¼ è¾“å®Œæˆâ€çŠ¶æ€ã€‚ è¿™ä¸ªçŠ¶æ€ä½ç”¨äºæŒ‡ç¤ºæ•°æ®åŒ…å·²ç»æˆåŠŸå‘é€ã€‚
    *&#x2F;
  if(!(tx_ring[tail].status &amp; E1000_TXD_STAT_DD))&#123;     
    release(&amp;e1000_lock);  &#x2F;&#x2F;é˜Ÿåˆ—æ»¡ï¼Œé‡Šæ”¾é”
    return -1;&#x2F;&#x2F;è¿”å›é”™è¯¯
  &#125;
  
  if(tx_mbufs[tail])  &#x2F;&#x2F;é‡Šæ”¾ä¹‹å‰å‘é€é˜Ÿåˆ—çš„æœ«å°¾tailæ•°æ®åŒ…å¯¹åº”çš„å†…å­˜ç©ºé—´ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    mbuffree(tx_mbufs[tail]);
  
  &#x2F;&#x2F;å¡«å…… tx_ring[tail] æ•°æ®ç»“æ„ä¸­çš„å­—æ®µï¼šcmd åŸŸå’Œ length åŸŸç”¨äºæ§åˆ¶æ•°æ®åŒ…çš„å‘é€æ–¹å¼ï¼Œaddr åŸŸæŒ‡å‘å¾…å‘é€çš„æ•°æ®å—çš„åœ°å€ï¼›
  memset(&amp;tx_ring[tail], 0, sizeof(struct tx_desc));
  tx_ring[tail].cmd &#x3D; (E1000_TXD_CMD_EOP | E1000_TXD_CMD_RS);
  tx_ring[tail].addr &#x3D; (uint64)m-&gt;head;
  tx_ring[tail].length &#x3D; m-&gt;len;
  &#x2F;&#x2F;å°† m å¯¹åº”çš„æ•°æ®å—æ·»åŠ åˆ°å‘é€é˜Ÿåˆ—ä¸­
  tx_mbufs[tail] &#x3D; m;   
  &#x2F;&#x2F;æ›´æ–° E1000_TDT å¯„å­˜å™¨ï¼ŒæŒ‡å‘æ–°çš„å°¾æŒ‡é’ˆã€‚
  regs[E1000_TDT] &#x3D; (tail + 1) % TX_RING_SIZE;  
  
  &#x2F;&#x2F;æœ€åå‡½æ•°é‡Šæ”¾ç½‘ç»œè®¾å¤‡çš„é”ï¼Œå¹¶è¿”å› 0ï¼Œè¡¨ç¤ºæ•°æ®åŒ…å·²ç»æˆåŠŸæ·»åŠ åˆ°å‘é€é˜Ÿåˆ—ä¸­ã€‚
  release(&amp;e1000_lock);
  return 0;
&#125;</code></pre>

<p>ä»£ç ä¸­çš„å®šä¹‰éƒ½å¯ä»¥åœ¨ä¸Šé¢çš„<strong>ä¸€äº›å®šä¹‰</strong>ä¸­çœ‹åˆ°</p>
<h3 id="recv"><a href="#recv" class="headerlink" title="recv()"></a>recv()</h3><p>vim kernel&#x2F;e1000.c   e1000_recv(void):</p>
<p>åœ¨23è¡Œä»¥åŠ33è¡Œæ·»åŠ ä»£ç ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">struct spinlock e1000_lockrx;

&#x2F;&#x2F; e1000_init()
initlock(&amp;e1000_lockrx, &quot;e1000_rx&quot;);</code></pre>

<p>æ’å…¥ä¹‹åå¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309181326166.png" alt="image-20230918132640088" style="zoom:67%;" />



<p>æ¥ç€æ‰¾åˆ°e1000_recvå‡½æ•°ï¼š</p>
<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309181316280.png" alt="image-20230918131629212" style="zoom:67%;" />

<p>æ·»åŠ ä»£ç å¦‚ä¸‹ï¼š</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">static void
e1000_recv(void)
&#123;
  while(1)&#123; &#x2F;&#x2F;è¿›å…¥æ— é™å¾ªç¯ï¼Œä¸æ–­æ¥å—ç½‘ç»œæ•°æ®åŒ…
    &#x2F;&#x2F;è·å–ä¸‹ä¸€ä¸ªæ¥æ”¶é˜Ÿåˆ—æè¿°ç¬¦çš„ç´¢å¼•ï¼ˆidxï¼‰ï¼Œè¿™é‡Œä½¿ç”¨äº†ç¯å½¢ç¼“å†²åŒºï¼ˆRX_RINGï¼‰æ¥å­˜å‚¨æ¥æ”¶é˜Ÿåˆ—ã€‚
    uint idx &#x3D; (regs[E1000_RDT] + 1) % RX_RING_SIZE;
    &#x2F;&#x2F;æ ¹æ®ç´¢å¼•è·å–è¯¥æ¥æ”¶é˜Ÿåˆ—æè¿°ç¬¦ï¼ˆdescï¼‰çš„æŒ‡é’ˆ
    struct rx_desc *desc &#x3D; &amp;rx_ring[idx];
     &#x2F;&#x2F;åˆ¤æ–­è¯¥æ¥æ”¶é˜Ÿåˆ—æè¿°ç¬¦çš„çŠ¶æ€æ ‡å¿—ä½ï¼ˆstatusï¼‰æ˜¯å¦ä¸ºâ€œæ•°æ®æ¥æ”¶å®Œæˆâ€ï¼ˆDDï¼‰ã€‚å¦‚æœæ²¡æœ‰ï¼Œåˆ™è¿”å›å¹¶ç­‰å¾…ä¸‹ä¸€ä¸ªæ•°æ®åŒ…ã€‚
    if(!(desc-&gt;status &amp; E1000_RXD_STAT_DD))&#123;
      return;
    &#125; 
    &#x2F;&#x2F;ä»æ¥æ”¶ç¼“å†²åŒºï¼ˆrx_mbufsï¼‰ä¸­è·å–å¯¹åº”çš„ç½‘ç»œæ•°æ®åŒ…ï¼ˆmbufï¼‰ï¼Œå¹¶è®¾ç½®å…¶é•¿åº¦ä¸ºæ¥æ”¶é˜Ÿåˆ—æè¿°ç¬¦ä¸­æŒ‡å®šçš„é•¿åº¦ã€‚
    rx_mbufs[idx]-&gt;len &#x3D; desc-&gt;length;
    &#x2F;&#x2F;å°†è¯¥ç½‘ç»œæ•°æ®åŒ…ä¼ é€’ç»™net_rxå‡½æ•°è¿›è¡Œå¤„ç†ã€‚
    net_rx(rx_mbufs[idx]);
    &#x2F;&#x2F;åˆ†é…ä¸€ä¸ªæ–°çš„æ¥æ”¶ç¼“å†²åŒºï¼ˆmbufï¼‰ï¼Œå¹¶å°†å…¶æŒ‡é’ˆå­˜å‚¨åœ¨æ¥æ”¶é˜Ÿåˆ—æè¿°ç¬¦ä¸­æŒ‡å®šçš„åœ°å€ï¼ˆaddrï¼‰ä¸­
    rx_mbufs[idx] &#x3D; mbufalloc(0);
    desc-&gt;addr &#x3D; rx_mbufs[idx]-&gt;head;
    desc-&gt;status &#x3D; 0;&#x2F;&#x2F;å°†æ¥æ”¶é˜Ÿåˆ—æè¿°ç¬¦çš„çŠ¶æ€æ ‡å¿—ä½æ¸…é›¶ï¼ˆstatus &#x3D; 0ï¼‰
    regs[E1000_RDT] &#x3D; idx;&#x2F;&#x2F;æ›´æ–°æ¥æ”¶é˜Ÿåˆ—çš„è¯»æŒ‡é’ˆï¼ˆE1000_RDTï¼‰ä¸ºä¸‹ä¸€ä¸ªæ¥æ”¶é˜Ÿåˆ—æè¿°ç¬¦çš„ç´¢å¼•ï¼ˆidxï¼‰
  &#125;
&#125;</code></pre>

<p>ä»£ç ä¸­çš„å®šä¹‰éƒ½å¯ä»¥åœ¨ä¸Šé¢çš„<strong>ä¸€äº›å®šä¹‰</strong>ä¸­çœ‹åˆ°</p>
<hr>
<p>:wqä¿å­˜é€€å‡ºã€‚é‡æ–°ç¼–è¯‘ï¼Œæ²¡å‡ºç°é—®é¢˜ã€‚</p>
<p>&#x3D;&#x3D;å®Œç»“æ’’èŠ±&#x3D;&#x3D;</p>
<p>å†è¯´ä¸€éå¿…çœ‹ï¼š<a target="_blank" rel="noopener" href="https://ttzytt.com/2022/08/xv6_lab8_record/">https://ttzytt.com/2022/08/xv6_lab8_record/</a></p>
<p>ç»ˆäºç»“æŸäº†ã€‚çœŸæœ‰ç§è½»èˆŸå·²è¿‡ä¸‡é‡å±±çš„æ„Ÿè§‰ã€‚ã€‚ã€‚ã€‚ã€‚ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…ğŸ˜…</p>
<hr>
<h1 id="å­¦ä¹ ç¬”è®°"><a href="#å­¦ä¹ ç¬”è®°" class="headerlink" title="å­¦ä¹ ç¬”è®°"></a>å­¦ä¹ ç¬”è®°</h1><h2 id="1-1è¿›ç¨‹å’Œå†…å­˜"><a href="#1-1è¿›ç¨‹å’Œå†…å­˜" class="headerlink" title="1.1è¿›ç¨‹å’Œå†…å­˜"></a>1.1è¿›ç¨‹å’Œå†…å­˜</h2><p>ä¸€ã€ç»ˆç«¯æ‰§è¡Œå‘½ä»¤è¿‡ç¨‹ï¼š</p>
<p>ç”¨æˆ·è¾“å…¥å‘½ä»¤ï¼Œshellé€šè¿‡getcmd()è¯»å–ä¸€è¡Œï¼Œç„¶åè°ƒç”¨<code>fork</code>åˆ›å»ºä¸€ä¸ªshellè¿›ç¨‹çš„å‰¯æœ¬ã€‚çˆ¶è¿›ç¨‹è°ƒç”¨<code>wait</code>ï¼Œå­è¿›ç¨‹æ‰§è¡Œå‘½ä»¤ã€‚ä¾‹å¦‚ï¼šå½“ç”¨æˆ·å‘shellè¾“å…¥echo helloæ—¶ï¼Œruncmd(user&#x2F;sh.c:58) å°†ä»¥echo helloä¸ºå‚æ•°è¢«è°ƒç”¨æ¥æ‰§è¡Œå®é™…å‘½ä»¤ã€‚å¯¹äºâ€œecho helloâ€ï¼Œå®ƒå°†è°ƒç”¨exec(user&#x2F;sh.c:78)ã€‚å¦‚æœexecæˆåŠŸï¼Œé‚£ä¹ˆå­è¿›ç¨‹å°†ä»echoè€Œä¸æ˜¯runcmdæ‰§è¡Œå‘½ä»¤ï¼Œåœ¨æŸåˆ»echoä¼šè°ƒç”¨exitï¼Œè¿™å°†å¯¼è‡´çˆ¶è¿›ç¨‹ä»main(user&#x2F;sh.c:78)ä¸­çš„waitè¿”å›ã€‚</p>
<pre class="line-numbers language-c" data-language="c"><code class="language-c">&#x2F;&#x2F; usr&#x2F;sh.c
int
getcmd(char *buf, int nbuf)
&#123;
  write(2, &quot;$ &quot;,2 );   &#x2F;&#x2F;ä¹Ÿå°±æ˜¯è¿™é‡Œå¯ä»¥è‡ªå®šä¹‰shellçš„è¯»å–ç¬¦ 
  memset(buf, 0, nbuf);
  gets(buf, nbuf);
  if(buf[0] &#x3D;&#x3D; 0) &#x2F;&#x2F; EOF
    return -1;
  return 0;
&#125;</code></pre>

<pre class="line-numbers language-c" data-language="c"><code class="language-c">write(2, &quot;$ &quot;,2 );  
&#x2F;&#x2F;æ¯ä¸ªå‚æ•°çš„å«ä¹‰å¦‚ä¸‹ï¼š
&#x2F;&#x2F;ç¬¬ä¸€ä¸ªå‚æ•° 2ï¼šè¡¨ç¤ºæ–‡ä»¶æè¿°ç¬¦ï¼Œè¿™é‡Œæ˜¯æ ‡å‡†é”™è¯¯è¾“å‡ºï¼ˆstderrï¼‰çš„æ–‡ä»¶æè¿°ç¬¦ã€‚
&#x2F;&#x2F;ç¬¬äºŒä¸ªå‚æ•° &quot;&amp; &quot;ï¼šè¡¨ç¤ºè¦å†™å…¥çš„æ•°æ®çš„èµ·å§‹åœ°å€ï¼Œå³ä¸€ä¸ªæŒ‡å‘è¦å†™å…¥çš„å­—ç¬¦æ•°ç»„çš„æŒ‡é’ˆã€‚
&#x2F;&#x2F;ç¬¬ä¸‰ä¸ªå‚æ•° 2ï¼šè¡¨ç¤ºè¦å†™å…¥çš„æ•°æ®çš„é•¿åº¦ï¼Œå³è¦å†™å…¥çš„å­—ç¬¦æ•°ç»„çš„é•¿åº¦ã€‚
&#x2F;&#x2F;æ¯”å¦‚å¯ä»¥æ”¹æˆ @-@ ï¼Œä¿®æ”¹æˆ write(2,&quot;@-@&quot;,4);  &#x2F;&#x2F;(ä¸ºäº†ç¾è§‚ä¸€èˆ¬é•¿åº¦å¤šå‡ºä¸ªç©ºæ ¼)</code></pre>

<p>åœ¨ xv6 æ“ä½œç³»ç»Ÿä¸­ï¼Œ<code>runcmd</code> å’Œ <code>exec</code> è¿™ä¸¤ä¸ªå‡½æ•°éƒ½ç”¨äºè¿è¡ŒæŒ‡ä»¤ã€‚</p>
<p><code>runcmd</code> å‡½æ•°ç”¨äºè§£æç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œå¹¶æ ¹æ®å‘½ä»¤ç±»å‹è°ƒç”¨ç›¸åº”çš„æ‰§è¡Œå‡½æ•°ã€‚å®ƒæ¥æ”¶ä¸€ä¸ª <code>struct cmd*</code> ç±»å‹çš„å‚æ•°ï¼Œè¯¥ç»“æ„ä½“åŒ…å«äº†ç”¨æˆ·è¾“å…¥çš„å‘½ä»¤çš„å„ä¸ªéƒ¨åˆ†ï¼ˆä¾‹å¦‚å‘½ä»¤åç§°ã€å‚æ•°ç­‰ï¼‰ã€‚<code>runcmd</code> å‡½æ•°ä¼šæ ¹æ®å‘½ä»¤çš„ç±»å‹ï¼Œè°ƒç”¨ç›¸åº”çš„æ‰§è¡Œå‡½æ•°æ¥æ‰§è¡Œå‘½ä»¤ã€‚</p>
<p>å¯¹äºæ™®é€šçš„å¤–éƒ¨å‘½ä»¤ï¼ˆä¾‹å¦‚ lsã€cat ç­‰ï¼‰ï¼Œ<code>runcmd</code> å‡½æ•°ä¼šè°ƒç”¨ <code>runcmd_execcmd</code> å‡½æ•°æ¥æ‰§è¡Œã€‚<code>runcmd_execcmd</code> ä¸»è¦çš„å·¥ä½œæ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„å­è¿›ç¨‹å¹¶åŠ è½½ç”¨æˆ·ç©ºé—´çš„ç¨‹åºä»£ç ï¼Œç„¶ååœ¨å­è¿›ç¨‹ä¸­ä½¿ç”¨ <code>exec</code> ç³»ç»Ÿè°ƒç”¨æ¥æ‰§è¡Œè¿™ä¸ªå‘½ä»¤ã€‚è¿™æ ·å¯ä»¥å®ç°åœ¨å­è¿›ç¨‹ä¸­å¯åŠ¨ä¸€ä¸ªæ–°çš„ç¨‹åºï¼Œè€Œä¸æ˜¯åœ¨å½“å‰è¿›ç¨‹ä¸­æ‰§è¡Œã€‚</p>
<p>åœ¨ <code>exec</code> ç³»ç»Ÿè°ƒç”¨ä¸­ï¼Œå°†ä¼šåŠ è½½æŒ‡å®šç¨‹åºçš„ä»£ç å’Œæ•°æ®åˆ°å†…å­˜ä¸­ï¼Œå¹¶å°†è¿›ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢åˆ°æ–°ç¨‹åºçš„èµ·å§‹ç‚¹ã€‚è¿™æ ·ï¼Œæ–°ç¨‹åºå°±å¯ä»¥å¼€å§‹æ‰§è¡Œäº†ã€‚<code>exec</code> ç³»ç»Ÿè°ƒç”¨ä¼šæ›¿æ¢å½“å‰è¿›ç¨‹çš„åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨åï¼ŒåŸè¿›ç¨‹çš„ä»£ç å’Œæ•°æ®éƒ½è¢«æ–°ç¨‹åºå–ä»£äº†ã€‚</p>
<p>æ€»ä¹‹ï¼Œ<code>runcmd</code> å‡½æ•°è§£æç”¨æˆ·è¾“å…¥çš„å‘½ä»¤ï¼Œæ ¹æ®å‘½ä»¤ç±»å‹è°ƒç”¨ç›¸åº”çš„æ‰§è¡Œå‡½æ•°ã€‚å¯¹äºå¤–éƒ¨å‘½ä»¤ï¼Œä½¿ç”¨ <code>exec</code> ç³»ç»Ÿè°ƒç”¨åœ¨å­è¿›ç¨‹ä¸­åŠ è½½å¹¶æ‰§è¡ŒæŒ‡å®šçš„ç¨‹åºã€‚è¿™æ ·å°±å®ç°äº†è¿è¡ŒæŒ‡ä»¤çš„åŠŸèƒ½ã€‚</p>
<h2 id="2-4xv6æ¶æ„ç¯‡"><a href="#2-4xv6æ¶æ„ç¯‡" class="headerlink" title="2.4xv6æ¶æ„ç¯‡"></a>2.4xv6æ¶æ„ç¯‡</h2><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309151718283.png" alt="image-20230915171844153" style="zoom: 50%;" />

<img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309151719164.png" alt="image-20230915171908066" style="zoom:50%;" />



<h1 id="Other"><a href="#Other" class="headerlink" title="Other"></a>Other</h1><h2 id="å®šåˆ¶ä½ çš„shell"><a href="#å®šåˆ¶ä½ çš„shell" class="headerlink" title="å®šåˆ¶ä½ çš„shell"></a>å®šåˆ¶ä½ çš„shell</h2><h3 id="1ã€-å®šåˆ¶shellå¯åŠ¨æ¬¢è¿ç•Œé¢"><a href="#1ã€-å®šåˆ¶shellå¯åŠ¨æ¬¢è¿ç•Œé¢" class="headerlink" title="1ã€ å®šåˆ¶shellå¯åŠ¨æ¬¢è¿ç•Œé¢"></a>1ã€ å®šåˆ¶shellå¯åŠ¨æ¬¢è¿ç•Œé¢</h3><p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309152215059.png" alt="image-20230915221550839"></p>
<p>vim kernel&#x2F;main.c</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171525400.png" alt="image-20230917152542285"></p>
<p>åœ¨è¿™ä¸ªä½ç½®æ’å…¥ä½ æƒ³è‡ªå®šä¹‰çš„æ¬¢è¿ç•Œé¢ã€‚</p>
<p>å¦‚æœä½ ä¹Ÿæƒ³æœ‰ä¸Šé¢çš„ç‰¹æ®Šå­—ä¸²ï¼Œclickè¿™ä¸ªç½‘ç«™ï¼š<a target="_blank" rel="noopener" href="http://patorjk.com/software/taag/#p=testall&f=Mer&t=Hello%20World">http://patorjk.com/software/taag/#p=testall&amp;f=Mer&amp;t=Hello%20World</a></p>
<h3 id="2ã€å®šåˆ¶å‘½ä»¤æç¤ºç¬¦"><a href="#2ã€å®šåˆ¶å‘½ä»¤æç¤ºç¬¦" class="headerlink" title="2ã€å®šåˆ¶å‘½ä»¤æç¤ºç¬¦"></a>2ã€å®šåˆ¶å‘½ä»¤æç¤ºç¬¦</h3><p>vim user&#x2F;sh.c   getcmd</p>
<p><img src="https://raw.githubusercontent.com/Hopefuling/pic_save/master/img/202309171529910.png" alt="image-20230917152941849"></p>
<p>ä¿®æ”¹write(2,â€$â€,2);å³å¯ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°2æ˜¯æˆªå–ç¬¬äºŒä¸ªå‚æ•°å­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</p>
<p>ä¿®æ”¹æˆå­¦å·å¯æ›´æ”¹ä¸º write(2,â€20212131102$ â€œ,13);   å¤šç•™ä¸€ä¸ªç©ºæ ¼å‡ºæ¥ï¼Œå› æ­¤æˆªå–é•¿åº¦è®¾ç½®ä¸º13ã€‚</p>
<h2 id="linuxå¸¸ç”¨å‘½ä»¤"><a href="#linuxå¸¸ç”¨å‘½ä»¤" class="headerlink" title="linuxå¸¸ç”¨å‘½ä»¤"></a>linuxå¸¸ç”¨å‘½ä»¤</h2><p>ls  æ˜¾ç¤ºå½“å‰ç›®å½•ä¸‹æ‰€æœ‰æ–‡ä»¶  å¯é€‰å‚æ•° -a  -l </p>
<p>history  æ˜¾ç¤ºè¾“å…¥å‘½ä»¤å†å²</p>
<p>cd  è¿›å…¥æ–‡ä»¶å¤¹    cd .. è¿”å›ä¸Šä¸€çº§</p>
<p>cp æ‹·è´copy        cp A B     æŠŠAå¤åˆ¶ä¸€ä»½å¹¶ä¸”å‘½åä¸ºB</p>
<p>rm  åˆ é™¤remove      rm a</p>
<p>mv é‡å‘½å   mv a  b  æŠŠAé‡å‘½åä¸ºB</p>
<h2 id="vimå¸¸ç”¨å‘½ä»¤"><a href="#vimå¸¸ç”¨å‘½ä»¤" class="headerlink" title="vimå¸¸ç”¨å‘½ä»¤"></a>vimå¸¸ç”¨å‘½ä»¤</h2><p>i æ’å…¥æ¨¡å¼</p>
<p>:set nu  æ˜¾ç¤ºè¡Œå·</p>
<p>gg å›åˆ°é¡¶éƒ¨</p>
<p>gè·³åˆ°å°¾éƒ¨</p>
<p>uæ’¤é”€</p>
<p>oåœ¨ä¸‹ä¸€è¡Œæ’å…¥</p>
<p>h j k l   å·¦ä¸‹ä¸Šå³</p>
<p>wä¸‹ä¸€ä¸ªå•è¯</p>

</div>

</main>
    <footer>
  <div class="footer-info">
    Â© 2023- Hopefuling | Powerd by
    <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> | Theme
    <a target="_blank" rel="noopener" href="https://github.com/mizoreyo/hexo-theme-insnow">Insnow</a>
    <!-- <a target="_blank" rel="noopener" href="https://beian.miit.gov.cn/">èœ€ICPï¿½?20005398ï¿½?</a> -->
  </div>
  <div class="footer-info">
    <!-- <a class="footer-i" target="_blank" rel="noopener" href="https://cdn.jsdelivr.net/gh/mizoreyo/static/images/wechat.PNG"
      ><i class="iconfont icon-wechat"></i
    ></a> -->
    <a class="footer-i" target="_blank" rel="noopener" href="https://github.com/mizoreyo"
      ><i class="iconfont icon-github-fill"></i
    ></a>
    <!-- <a class="footer-i" href="/atom.xml"
      ><i class="iconfont icon-rss"></i
    ></a> -->
    <!-- <a class="footer-i" href="mailto:mizoreyo@outlook.com"
      ><i class="iconfont icon-mail"></i
    ></a> -->
  </div>
</footer>

  </div>
</body>


</html>